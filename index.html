<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <title>Городской Транспорт</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            -webkit-tap-highlight-color: transparent;

        }



        body {

            background: #fff;

            min-height: 100vh;

            padding: 0;

            margin: 0;

            display: flex;

            flex-direction: column;

        }



        .container {

            max-width: 600px;

            margin: 0 auto;

            width: 100%;

            padding: 16px;

        }



        .tabs {

            display: flex;

            margin-bottom: 20px;

            border-bottom: 1px solid rgba(0, 0, 0, 0.1);

            margin: 0 -16px 20px;

        }



        .tab {

            flex: 1;

            padding: 16px;

            text-align: center;

            color: #8E8E93;

            cursor: pointer;

            position: relative;

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 8px;

            font-size: 15px;

            font-weight: 400;

        }



        .tab svg {

            width: 20px;

            height: 20px;

        }



        .tab.active {

            color: #000;

        }



        .tab.active svg {

            color: #E31E24;

        }



        .tab.active:after {

            content: '';

            position: absolute;

            bottom: -1px;

            left: 16px;

            right: 16px;

            height: 2px;

            background: #E31E24;

        }



        .tab-content {

            display: none;

        }



        .tab-content.active {

            display: block;

        }



        .form-group {

            margin-bottom: 20px;

        }



        label {

            display: block;

            margin-bottom: 8px;

            font-weight: 400;

            color: #8E8E93;

            font-size: 15px;

        }



        input, select {

            width: 100%;

            padding: 12px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 10px;

            font-size: 17px;

            background: #fff;

            color: #000;

        }



        input:focus, select:focus {

            outline: none;

            border-color: #E31E24;

        }



        input::placeholder {

            color: #8E8E93;

        }



        button {

            width: 100%;

            padding: 16px;

            background: #E31E24;

            border: none;

            border-radius: 14px;

            color: white;

            font-size: 17px;

            font-weight: 500;

            cursor: pointer;

            margin-top: 24px;

        }



        .error {

            color: #E31E24;

            font-size: 13px;

            margin-top: 4px;

            display: none;

        }



        .saved-tickets {

            display: flex;

            flex-direction: column;

            gap: 12px;

        }



        .ticket-item {

            background: #fff;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 12px;

            padding: 16px;

        }



        .ticket-info {

            display: flex;

            justify-content: space-between;

            align-items: center;

            gap: 12px;

        }



        .ticket-details {

            flex: 1;

        }



        .ticket-number {

            font-size: 20px;

            color: #E31E24;

            margin-bottom: 4px;

        }



        .ticket-route {

            font-size: 15px;

            color: #8E8E93;

        }



        .ticket-actions {

            display: flex;

            gap: 8px;

        }



        .edit-btn, .open-btn {

            padding: 8px 16px;

            background: #F7F7F7;

            border: none;

            border-radius: 8px;

            color: #000;

            font-size: 15px;

            cursor: pointer;

            white-space: nowrap;

            width: auto;

            margin: 0;

        }



        .edit-form {

            display: none;

            margin-top: 12px;

            padding-top: 12px;

            border-top: 1px solid rgba(0, 0, 0, 0.1);

        }



        .edit-form.active {

            display: block;

        }



        .edit-field {

            width: 100%;

            padding: 8px 12px;

            margin-bottom: 8px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 8px;

            font-size: 15px;

        }



        .edit-actions {

            display: flex;

            gap: 8px;

            margin-top: 12px;

        }



        .save-btn, .cancel-btn {

            flex: 1;

            padding: 8px 16px;

            border-radius: 8px;

            border: none;

            font-size: 15px;

            cursor: pointer;

            margin: 0;

        }



        .save-btn {

            background: #E31E24;

            color: white;

        }



        .cancel-btn {

            background: #F7F7F7;

            color: #000;

        }



        @media (max-width: 380px) {

            .ticket-info {

                flex-direction: column;

                align-items: flex-start;

            }



            .ticket-actions {

                width: 100%;

            }



            .edit-btn, .open-btn {

                flex: 1;

                text-align: center;

            }

        }



        .cost-selector {

            display: flex;

            gap: 12px;

            margin-top: 8px;

        }



        .cost-option {

            flex: 1;

            display: flex;

            align-items: center;

            justify-content: center;

            padding: 12px;

            background: #F7F7F7;

            border-radius: 10px;

            cursor: pointer;

            transition: all 0.2s;

        }



        .cost-option input {

            display: none;

        }



        .cost-option span {

            font-size: 17px;

            color: #8E8E93;

            transition: all 0.2s;

        }



        .cost-option input:checked + span {

            color: #000;

            font-weight: 500;

        }



        .cost-option:has(input:checked) {

            background: rgba(227, 30, 36, 0.1);

        }



        .edit-field {

            width: 100%;

            padding: 12px;

            margin-bottom: 12px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 10px;

            font-size: 15px;

            background: #fff;

        }



        .edit-field::placeholder {

            color: #8E8E93;

        }



        .edit-field:focus {

            outline: none;

            border-color: #E31E24;

        }

    </style>

</head>

<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="constructor">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M4 4h16v12H4V4zm8 12v4m-4 0h8M4 8h16M4 12h16"/>
                </svg>
                Конструктор
            </div>
            <div class="tab" data-tab="saved">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                Сохраненные
            </div>
        </div>

        <div class="tab-content active" id="constructor-content">
            <div class="form-group">
                <label for="routeNumber">Номер маршрута</label>
                <input type="number" id="routeNumber" min="1" max="99" placeholder="Введите номер (1-99)">
            </div>
            <div class="input-group">
                <label for="carrier">Перевозчик</label>
                <select id="carrier" required>
                    <option value="">Выберите перевозчика</option>
                    <!-- Опции будут добавлены динамически -->
                </select>
            </div>
            <div class="form-group">
                <label for="route">Маршрут</label>
                <input type="text" id="route" placeholder="Например: Красфарма (60 лет Октября) - Х/К Енисей">
            </div>
            <div class="form-group">
                <label for="vehicle">Гос. номер</label>
                <input type="text" id="vehicle" placeholder="Например: р471тм124">
            </div>
            <div class="form-group">
                <label for="cost">Стоимость</label>
                <div class="cost-selector">
                    <label class="cost-option">
                        <input type="radio" name="cost" value="44.00" checked>
                        <span>44.00₽</span>
                    </label>
                    <label class="cost-option">
                        <input type="radio" name="cost" value="40.00">
                        <span>40.00₽</span>
                    </label>
                </div>
            </div>
            <button onclick="generateTicket()">Создать билет</button>
        </div>

        <div class="tab-content" id="saved-content">
            <div id="saved-tickets-list" class="saved-tickets"></div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // Встроенные данные о маршрутах и перевозчиках
        const routesData = {
            "routes": {
                "3": {
                    "name": "Маршрут 3",
                    "carriers": ["ИП Патрин Н.Н.", "ООО \"СТК\""]
                },
                "99": {
                    "name": "Маршрут 99",
                    "carriers": ["ООО \"СТК\"", "ИП Патрин Н.Н"]
                }
                // Добавьте другие маршруты по необходимости
            },
            "allCarriers": [
                "ИП Патрин Н.Н.",
                "ООО \"СТК\"",
                "КПАТП-7",
                "МП «ГОРТРАНС»",
                "ИП Тагачаков В.Г.",
                "ООО «Экипаж-ГО»"
                // Добавьте других перевозчиков по необходимости
            ]
        };

        // Заполнение выпадающего списка перевозчиков
        function populateCarrierDropdown() {
            const carrierSelect = document.getElementById('carrier');
            
            // Очищаем текущие опции
            carrierSelect.innerHTML = '';
            
            // Добавляем пустую опцию
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Выберите перевозчика';
            carrierSelect.appendChild(emptyOption);
            
            // Добавляем всех перевозчиков
            routesData.allCarriers.forEach(carrier => {
                const option = document.createElement('option');
                option.value = carrier;
                option.textContent = carrier;
                carrierSelect.appendChild(option);
            });
        }

        // Обновление перевозчика на основе выбранного маршрута
        function updateCarrierBasedOnRoute() {
            const routeNumber = document.getElementById('routeNumber').value;
            const carrierSelect = document.getElementById('carrier');
            
            // Если маршрут не выбран
            if (!routeNumber) return;
            
            // Находим маршрут в данных
            const route = routesData.routes[routeNumber];
            
            // Если маршрут найден и у него есть перевозчики
            if (route && route.carriers && route.carriers.length > 0) {
                // Если у маршрута только один перевозчик, выбираем его
                if (route.carriers.length === 1) {
                    carrierSelect.value = route.carriers[0];
                } else {
                    // Если у маршрута несколько перевозчиков, оставляем выбор пользователю
                    // но ограничиваем список только перевозчиками этого маршрута
                    
                    // Очищаем текущие опции
                    carrierSelect.innerHTML = '';
                    
                    // Добавляем пустую опцию
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Выберите перевозчика для маршрута ' + routeNumber;
                    carrierSelect.appendChild(emptyOption);
                    
                    // Добавляем перевозчиков для этого маршрута
                    route.carriers.forEach(carrier => {
                        const option = document.createElement('option');
                        option.value = carrier;
                        option.textContent = carrier;
                        carrierSelect.appendChild(option);
                    });
                }
            } else {
                // Если маршрут не найден, показываем всех перевозчиков
                populateCarrierDropdown();
            }
        }

        // Заполняем выпадающий список при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            populateCarrierDropdown();
            document.getElementById('routeNumber').addEventListener('change', updateCarrierBasedOnRoute);
        });

        // Функция генерации случайного номера билета
        function generateRandomTicketNumber() {
            return Math.floor(Math.random() * 900000000 + 100000000).toString();
        }

        // Форматирование даты
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year} г.`;
        }

        // Форматирование времени
        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        // Создание билета
        function generateTicket() {
            const routeNumber = document.getElementById('routeNumber').value;
            const carrier = document.getElementById('carrier').value;
            const route = document.getElementById('route').value;
            const vehicle = document.getElementById('vehicle').value;
            const cost = document.querySelector('input[name="cost"]:checked').value;

            if (!routeNumber || !carrier || !route || !vehicle) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            if (routeNumber < 1 || routeNumber > 99) {
                alert('Номер маршрута должен быть от 1 до 99');
                return;
            }

            // Не сохраняем дату и время в объекте билета
            const ticketData = {
                code: generateRandomTicketNumber(),
                routeNumber: routeNumber,
                carrier: carrier,
                route: route,
                vehicle: vehicle,
                cost: cost
            };

            // Сохраняем билет
            let savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            savedTickets.push(ticketData);
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

            // Формируем URL для ticket.html
            const params = new URLSearchParams();
            Object.entries(ticketData).forEach(([key, value]) => {
                params.append(key, value);
            });

            // Открываем билет
            window.location.href = 'ticket.html?' + params.toString();
        }

        // Загрузка сохраненных билетов
        function loadSavedTickets() {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const container = document.getElementById('saved-tickets-list');
            container.innerHTML = '';

            savedTickets.forEach((ticket, index) => {
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-item';
                ticketElement.innerHTML = `
                    <div class="ticket-info">
                        <div class="ticket-details">
                            <div class="ticket-number">${ticket.code}</div>
                            <div class="ticket-route">№${ticket.routeNumber} ${ticket.route}</div>
                        </div>
                        <div class="ticket-actions">
                            <button class="edit-btn" onclick="toggleEditForm(${index})">Изменить</button>
                            <button class="open-btn" onclick="openSavedTicket(${index})">Открыть</button>
                        </div>
                    </div>
                    <div class="edit-form" id="edit-form-${index}">
                        <input type="number" class="edit-field" id="edit-routeNumber-${index}" 
                               value="${ticket.routeNumber}" 
                               min="1" max="99"
                               placeholder="Номер маршрута (1-99)">
                        <input type="text" class="edit-field" id="edit-carrier-${index}" 
                               value="${ticket.carrier}" 
                               placeholder="Например: ИП Патрин Н. Н.">
                        <input type="text" class="edit-field" id="edit-route-${index}" 
                               value="${ticket.route}" 
                               placeholder="Например: Красфарма (60 лет Октября) - Х/К Енисей">
                        <input type="text" class="edit-field" id="edit-vehicle-${index}" 
                               value="${ticket.vehicle}" 
                               placeholder="Например: р471тм124">
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveEditedTicket(${index})">Сохранить</button>
                            <button class="cancel-btn" onclick="toggleEditForm(${index})">Отмена</button>
                        </div>
                    </div>
                `;
                container.appendChild(ticketElement);
            });
        }

        // Открытие сохраненного билета
        function openSavedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];
            const params = new URLSearchParams();
            Object.entries(ticket).forEach(([key, value]) => {
                params.append(key, value);
            });

            // Открываем билет (дата и время будут установлены в ticket.html)
            window.location.href = 'ticket.html?' + params.toString();
        }

        // Переключение формы редактирования
        function toggleEditForm(index) {
            const form = document.getElementById(`edit-form-${index}`);
            form.classList.toggle('active');
        }

        // Сохранение отредактированного билета
        function saveEditedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];

            const routeNumber = document.getElementById(`edit-routeNumber-${index}`).value;
            if (routeNumber < 1 || routeNumber > 99) {
                alert('Номер маршрута должен быть от 1 до 99');
                return;
            }

            ticket.routeNumber = routeNumber;
            ticket.carrier = document.getElementById(`edit-carrier-${index}`).value;
            ticket.route = document.getElementById(`edit-route-${index}`).value;
            ticket.vehicle = document.getElementById(`edit-vehicle-${index}`).value;

            savedTickets[index] = ticket;
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
            loadSavedTickets();
            toggleEditForm(index);
        }

        // Переключение вкладок
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-content').classList.add('active');
                
                if (tab.dataset.tab === 'saved') {
                    loadSavedTickets();
                }
            });
        });

        // Загрузка сохраненных билетов при старте
        if (document.querySelector('.tab[data-tab="saved"]').classList.contains('active')) {
            loadSavedTickets();
        }
    </script>
</body>

</html>

