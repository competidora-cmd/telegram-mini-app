<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0, viewport-fit=cover, shrink-to-fit=no">

    <title>Городской Транспорт</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        html, body {
            width: 100%;
            height: 100%;
        }
        *, *:before, *:after {
            box-sizing: border-box;
        }
        html {
            font-family: sans-serif;
            line-height: 1.15;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            -ms-overflow-style: scrollbar;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        @-ms-viewport {
            width: device-width;
        }
        body {
            margin: 0;
            color: #000000d9;
            font-size: 16px;
            font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";
            font-variant: tabular-nums;
            line-height: 1.5715;
            background-color: #fff;
            font-feature-settings: "tnum";
        }
        html {
            --antd-wave-shadow-color: #E21A1A;
            --scroll-bar: 0;
        }
        .ant-row {
            display: flex;
            flex-flow: row wrap;
            min-width: 0;
        }
        .ant-row:before, .ant-row:after {
            display: flex;
        }
        .ant-row-center {
            justify-content: center;
        }
        .ant-row-middle {
            align-items: center;
        }
        :root {
            --primary-color: #E21A1A;
            --font-size-base-number: 16;
            --font-size-sm-number: 15;
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }
        html {
            --tg-theme-button-color: #0066A1 !important;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #fff;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: fixed;
            width: 100%;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin: 0 -16px 20px;
        }
        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            color: #8E8E93;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 400;
        }
        .tab svg {
            width: 20px;
            height: 20px;
        }
        .tab.active {
            color: #000;
        }
        .tab.active svg {
            color: #E31E24;
        }
        .tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 16px;
            right: 16px;
            height: 2px;
            background: #E31E24;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #A2ACB0;
            font-size: 15px;
            font-family: Roboto, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 0.15px;
            line-height: 22px;
        }
        input, select {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(60, 60, 67, 0.1);
            border-radius: 14px;
            font-size: 16px;
            font-family: Roboto, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fff;
            color: #000;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            line-height: 24px;
            letter-spacing: 0.15px;
        }
        select {
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        input::placeholder {
            color: #A2ACB0;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 0.15px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.1);
        }
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
            padding: 0;
            border: none;
            margin: 24px 0;
            height: 44px;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            background: #E9E9EA;
            border: none;
            border-radius: 1px;
            transition: all 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 1px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.1);
            margin-top: -13px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #quantity-display {
            text-align: left;
            color: #000;
            font-size: 17px;
            margin-top: 12px;
            font-weight: 400;
        }
        .route-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        .route-endpoint {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(60, 60, 67, 0.1);
            border-radius: 14px;
            font-size: 17px;
            background: #fff;
            color: #000;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                font-size: 15px;
                margin-bottom: 8px;
                opacity: 0.8;
            }
            input, select, .route-endpoint {
                padding: 16px;
                font-size: 17px;
            }
            select, .route-endpoint {
                background-position: right 16px center;
                padding-right: 40px;
            }
            select:focus, .route-endpoint:focus {
                border-color: #007AFF;
                box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.1);
            }
        }
        .cost-selector {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .cost-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: #F5F5F5;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .cost-option:hover {
            background: #F0F0F0;
        }
        .cost-option input {
            display: none;
        }
        .cost-option span {
            font-size: 17px;
            color: #8E8E93;
            transition: all 0.2s ease;
            font-weight: 400;
        }
        .cost-option input:checked + span {
            color: #000;
            font-weight: 500;
        }
        .cost-option:has(input:checked) {
            background: #FFE5E5;
            border-color: rgba(227, 30, 36, 0.1);
        }
        button#createTicketBtn {
            width: 100%;
            padding: 16px;
            background: #E31E24;
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 32px;
            transition: all 0.2s ease;
        }
        button#createTicketBtn:hover {
            background: #D31E24;
        }
        button#createTicketBtn:active {
            transform: scale(0.98);
        }
        input:invalid {
            border-color: #FF3B30;
        }
        input:invalid:focus {
            border-color: #FF3B30;
            box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.1);
        }
        .helper-text {
            font-size: 12px;
            color: #8E8E93;
            margin-top: 4px;
            display: none;
        }
        input:focus + .helper-text {
            display: block;
        }
        .error-message {
            font-size: 12px;
            color: #FF3B30;
            margin-top: 4px;
            display: none;
        }
        input:invalid + .error-message {
            display: block;
        }
        .saved-tickets {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ticket-item {
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
        }
        .ticket-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .ticket-details {
            flex: 1;
        }
        .ticket-number {
            font-size: 20px;
            color: #E31E24;
            margin-bottom: 4px;
        }
        .ticket-route {
            font-size: 15px;
            color: #8E8E93;
        }
        .ticket-actions {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            justify-content: flex-end;
            min-width: 240px;
        }
        .edit-btn, .open-btn, .delete-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            white-space: nowrap;
            text-align: center;
            width: 80px;
            flex-shrink: 0;
        }
        .edit-btn, .open-btn {
            background: #F7F7F7;
            color: #000;
        }
        .delete-btn {
            background: #FFE5E5;
            color: #E31E24;
        }
        .edit-form {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .edit-form.active {
            display: block;
        }
        .edit-field {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 15px;
        }
        .edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .save-btn, .cancel-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            cursor: pointer;
            margin: 0;
        }
        .save-btn {
            background: #E31E24;
            color: white;
        }
        .cancel-btn {
            background: #F7F7F7;
            color: #000;
        }
        @media (max-width: 480px) {
            .ticket-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .ticket-actions {
                width: 100%;
                justify-content: space-between;
                min-width: unset;
            }
            .edit-btn, .open-btn, .delete-btn {
                flex: 1;
                width: auto;
                min-width: 70px;
            }
        }
        @media (max-width: 360px) {
            .ticket-actions {
                flex-wrap: wrap;
                gap: 8px;
            }
            .edit-btn, .open-btn, .delete-btn {
                min-width: calc(50% - 4px);
            }
            .delete-btn {
                width: 100%;
            }
        }
        .reverse-btn {
            padding: 4px;
            background: #F7F7F7;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            margin: 0 4px;
        }
        .reverse-btn:hover {
            background: #E8E8E8;
        }
        .reverse-btn svg {
            width: 16px;
            height: 16px;
            color: #8E8E93;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: white;
            border-radius: 14px;
            padding: 20px;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .modal-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            text-align: center;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }
        .modal-cancel {
            background: #F7F7F7;
            color: #000;
        }
        .modal-confirm {
            background: #E31E24;
            color: white;
        }
        @media (max-width: 480px) {
            .route-selector {
                flex-direction: column;
                gap: 12px;
            }
            .route-endpoint {
                width: 100%;
            }
            .reverse-btn {
                align-self: center;
                transform: rotate(90deg);
            }
        }
        .custom-slider {
            position: relative;
            width: 100%;
            height: 60px;
            padding: 15px 0;
            touch-action: none;
        }
        .slider-rail {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #E9E9EA;
            top: 50%;
            transform: translateY(-50%);
        }
        .slider-track {
            position: absolute;
            height: 2px;
            background-color: #E31E24;
            top: 50%;
            transform: translateY(-50%);
        }
        .slider-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
        }
        .slider-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #fff;
            border: 2px solid #E9E9EA;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: border-color 0.2s;
        }
        .slider-dot.active {
            border-color: #E31E24;
        }
        .slider-handle {
            position: absolute;
            width: 28px;
            height: 28px;
            background-color: #fff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 1px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }
        .slider-handle:hover {
            box-shadow: 0 0 2px rgba(0,0,0,0.15), 0 4px 8px rgba(0,0,0,0.15);
        }
        .slider-marks {
            position: absolute;
            width: 100%;
            top: calc(50% + 16px);
        }
        .slider-mark {
            position: absolute;
            transform: translateX(-50%);
            color: #8E8E93;
            font-size: 14px;
        }
        .slider-mark.active {
            color: #000;
        }
        .carrier-selection {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .auto-select-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 16px;
            background: #F7F7F7;
            border: 1px solid rgba(60, 60, 67, 0.1);
            border-radius: 14px;
            color: #000;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .auto-select-btn:hover {
            background: #E8E8E8;
        }
        .auto-select-btn svg {
            width: 20px;
            height: 20px;
        }
        @media (max-width: 480px) {
            .carrier-selection {
                flex-direction: column;
            }
            .auto-select-btn {
                width: 100%;
                justify-content: center;
            }
        }
        .verify-btn {
            width: 100%;
            padding: 16px;
            background: #E31E24;
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
        }
        .verify-btn:hover {
            background: #D31E24;
        }
        .verify-btn:active {
            transform: scale(0.98);
        }
        .verify-result {
            margin-top: 24px;
            padding: 16px;
            border-radius: 14px;
            background: #F7F7F7;
            font-size: 15px;
            line-height: 1.4;
        }
        .verify-result.success {
            background: #E8F5E9;
            color: #1B5E20;
        }
        .verify-result.error {
            background: #FFEBEE;
            color: #B71C1C;
        }
        .create-ticket-btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
            display: none;
        }
        .create-ticket-btn:hover {
            background: #43A047;
        }
        .create-ticket-btn:active {
            transform: scale(0.98);
        }
        #verify-content {
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 20px;
        }
        :root, :host {
            --fa-font-solid: normal 900 1em/1 "Font Awesome 6 Free";
            --fa-font-regular: normal 400 1em/1 "Font Awesome 6 Free";
            --fa-font-light: normal 300 1em/1 "Font Awesome 6 Pro";
            --fa-font-thin: normal 100 1em/1 "Font Awesome 6 Pro";
            --fa-font-duotone: normal 900 1em/1 "Font Awesome 6 Duotone";
            --fa-font-duotone-regular: normal 400 1em/1 "Font Awesome 6 Duotone";
            --fa-font-duotone-light: normal 300 1em/1 "Font Awesome 6 Duotone";
            --fa-font-duotone-thin: normal 100 1em/1 "Font Awesome 6 Duotone";
            --fa-font-brands: normal 400 1em/1 "Font Awesome 6 Brands";
            --fa-font-sharp-solid: normal 900 1em/1 "Font Awesome 6 Sharp";
            --fa-font-sharp-regular: normal 400 1em/1 "Font Awesome 6 Sharp";
            --fa-font-sharp-light: normal 300 1em/1 "Font Awesome 6 Sharp";
            --fa-font-sharp-thin: normal 100 1em/1 "Font Awesome 6 Sharp";
            --fa-font-sharp-duotone-solid: normal 900 1em/1 "Font Awesome 6 Sharp Duotone";
            --fa-font-sharp-duotone-regular: normal 400 1em/1 "Font Awesome 6 Sharp Duotone";
            --fa-font-sharp-duotone-light: normal 300 1em/1 "Font Awesome 6 Sharp Duotone";
            --fa-font-sharp-duotone-thin: normal 100 1em/1 "Font Awesome 6 Sharp Duotone";
        }

        svg:not(:root).svg-inline--fa, svg:not(:host).svg-inline--fa {
            overflow: visible;
            box-sizing: content-box;
        }

        .svg-inline--fa {
            display: var(--fa-display, inline-block);
            height: 1em;
            overflow: visible;
            vertical-align: -0.125em;
        }
        .svg-inline--fa.fa-2xs {
            vertical-align: 0.1em;
        }
        .svg-inline--fa.fa-xs {
            vertical-align: 0em;
        }
        .svg-inline--fa.fa-sm {
            vertical-align: -0.0714285705em;
        }
        .svg-inline--fa.fa-lg {
            vertical-align: -0.2em;
        }
        .svg-inline--fa.fa-xl {
            vertical-align: -0.25em;
        }
        .svg-inline--fa.fa-2xl {
            vertical-align: -0.3125em;
        }
        .svg-inline--fa.fa-pull-left {
            margin-right: var(--fa-pull-margin, 0.3em);
            width: auto;
        }
        .svg-inline--fa.fa-pull-right {
            margin-left: var(--fa-pull-margin, 0.3em);
            width: auto;
        }
        .svg-inline--fa.fa-li {
            width: var(--fa-li-width, 2em);
            top: 0.25em;
        }
        .svg-inline--fa.fa-fw {
            width: var(--fa-fw-width, 1.25em);
        }

        .fa-layers svg.svg-inline--fa {
            bottom: 0;
            left: 0;
            margin: auto;
            position: absolute;
            right: 0;
            top: 0;
        }

        .fa-layers-counter, .fa-layers-text {
            display: inline-block;
            position: absolute;
            text-align: center;
        }

        .fa-layers {
            display: inline-block;
            height: 1em;
            position: relative;
            text-align: center;
            vertical-align: -0.125em;
            width: 1em;
        }
        .fa-layers svg.svg-inline--fa {
            transform-origin: center center;
        }

        .fa-layers-text {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center center;
        }

        .fa-layers-counter {
            background-color: var(--fa-counter-background-color, #ff253a);
            border-radius: var(--fa-counter-border-radius, 1em);
            box-sizing: border-box;
            color: var(--fa-inverse, #fff);
            line-height: var(--fa-counter-line-height, 1);
            max-width: var(--fa-counter-max-width, 5em);
            min-width: var(--fa-counter-min-width, 1.5em);
            overflow: hidden;
            padding: var(--fa-counter-padding, 0.25em 0.5em);
            right: var(--fa-right, 0);
            text-overflow: ellipsis;
            top: var(--fa-top, 0);
            transform: scale(var(--fa-counter-scale, 0.25));
            transform-origin: top right;
        }

        .fa-layers-bottom-right {
            bottom: var(--fa-bottom, 0);
            right: var(--fa-right, 0);
            top: auto;
            transform: scale(var(--fa-layers-scale, 0.25));
            transform-origin: bottom right;
        }

        .fa-layers-bottom-left {
            bottom: var(--fa-bottom, 0);
            left: var(--fa-left, 0);
            right: auto;
            top: auto;
            transform: scale(var(--fa-layers-scale, 0.25));
            transform-origin: bottom left;
        }

        .fa-layers-top-right {
            top: var(--fa-top, 0);
            right: var(--fa-right, 0);
            transform: scale(var(--fa-layers-scale, 0.25));
            transform-origin: top right;
        }

        .fa-layers-top-left {
            left: var(--fa-left, 0);
            right: auto;
            top: var(--fa-top, 0);
            transform: scale(var(--fa-layers-scale, 0.25));
            transform-origin: top left;
        }

        .fa-1x {
            font-size: 1em;
        }

        .fa-2x {
            font-size: 2em;
        }

        .fa-3x {
            font-size: 3em;
        }

        .fa-4x {
            font-size: 4em;
        }

        .fa-5x {
            font-size: 5em;
        }

        .fa-6x {
            font-size: 6em;
        }

        .fa-7x {
            font-size: 7em;
        }

        .fa-8x {
            font-size: 8em;
        }

        .fa-9x {
            font-size: 9em;
        }

        .fa-10x {
            font-size: 10em;
        }

        .fa-2xs {
            font-size: 0.625em;
            line-height: 0.1em;
            vertical-align: 0.225em;
        }

        .fa-xs {
            font-size: 0.75em;
            line-height: 0.0833333337em;
            vertical-align: 0.125em;
        }

        .fa-sm {
            font-size: 0.875em;
            line-height: 0.0714285718em;
            vertical-align: 0.0535714295em;
        }

        .fa-lg {
            font-size: 1.25em;
            line-height: 0.05em;
            vertical-align: -0.075em;
        }

        .fa-xl {
            font-size: 1.5em;
            line-height: 0.0416666682em;
            vertical-align: -0.125em;
        }

        .fa-2xl {
            font-size: 2em;
            line-height: 0.03125em;
            vertical-align: -0.1875em;
        }

        .fa-fw {
            text-align: center;
            width: 1.25em;
        }

        .fa-ul {
            list-style-type: none;
            margin-left: var(--fa-li-margin, 2.5em);
            padding-left: 0;
        }
        .fa-ul > li {
            position: relative;
        }

        .fa-li {
            left: calc(-1 * var(--fa-li-width, 2em));
            position: absolute;
            text-align: center;
            width: var(--fa-li-width, 2em);
            line-height: inherit;
        }

        .fa-border {
            border-color: var(--fa-border-color, #eee);
            border-radius: var(--fa-border-radius, 0.1em);
            border-style: var(--fa-border-style, solid);
            border-width: var(--fa-border-width, 0.08em);
            padding: var(--fa-border-padding, 0.2em 0.25em 0.15em);
        }

        .fa-pull-left {
            float: left;
            margin-right: var(--fa-pull-margin, 0.3em);
        }

        .fa-pull-right {
            float: right;
            margin-left: var(--fa-pull-margin, 0.3em);
        }

        .fa-beat {
            animation-name: fa-beat;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, ease-in-out);
        }

        .fa-bounce {
            animation-name: fa-bounce;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, cubic-bezier(0.28, 0.84, 0.42, 1));
        }

        .fa-fade {
            animation-name: fa-fade;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, cubic-bezier(0.4, 0, 0.6, 1));
        }

        .fa-beat-fade {
            animation-name: fa-beat-fade;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, cubic-bezier(0.4, 0, 0.6, 1));
        }

        .fa-flip {
            animation-name: fa-flip;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, ease-in-out);
        }

        .fa-shake {
            animation-name: fa-shake;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, linear);
        }

        .fa-spin {
            animation-name: fa-spin;
            animation-delay: var(--fa-animation-delay, 0s);
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 2s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, linear);
        }

        .fa-spin-reverse {
            --fa-animation-direction: reverse;
        }

        .fa-pulse,
        .fa-spin-pulse {
            animation-name: fa-spin;
            animation-direction: var(--fa-animation-direction, normal);
            animation-duration: var(--fa-animation-duration, 1s);
            animation-iteration-count: var(--fa-animation-iteration-count, infinite);
            animation-timing-function: var(--fa-animation-timing, steps(8));
        }

        @media (prefers-reduced-motion: reduce) {
            .fa-beat,
            .fa-bounce,
            .fa-fade,
            .fa-beat-fade,
            .fa-flip,
            .fa-pulse,
            .fa-shake,
            .fa-spin,
            .fa-spin-pulse {
                animation-delay: -1ms;
                animation-duration: 1ms;
                animation-iteration-count: 1;
                transition-delay: 0s;
                transition-duration: 0s;
            }
        }
        @keyframes fa-beat {
            0%, 90% {
                transform: scale(1);
            }
            45% {
                transform: scale(var(--fa-beat-scale, 1.25));
            }
        }
        @keyframes fa-bounce {
            0% {
                transform: scale(1, 1) translateY(0);
            }
            10% {
                transform: scale(var(--fa-bounce-start-scale-x, 1.1), var(--fa-bounce-start-scale-y, 0.9)) translateY(0);
            }
            30% {
                transform: scale(var(--fa-bounce-jump-scale-x, 0.9), var(--fa-bounce-jump-scale-y, 1.1)) translateY(var(--fa-bounce-height, -0.5em));
            }
            50% {
                transform: scale(var(--fa-bounce-land-scale-x, 1.05), var(--fa-bounce-land-scale-y, 0.95)) translateY(0);
            }
            57% {
                transform: scale(1, 1) translateY(var(--fa-bounce-rebound, -0.125em));
            }
            64% {
                transform: scale(1, 1) translateY(0);
            }
            100% {
                transform: scale(1, 1) translateY(0);
            }
        }
        @keyframes fa-fade {
            50% {
                opacity: var(--fa-fade-opacity, 0.4);
            }
        }
        @keyframes fa-beat-fade {
            0%, 100% {
                opacity: var(--fa-beat-fade-opacity, 0.4);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(var(--fa-beat-fade-scale, 1.125));
            }
        }
        @keyframes fa-flip {
            50% {
                transform: rotate3d(var(--fa-flip-x, 0), var(--fa-flip-y, 1), var(--fa-flip-z, 0), var(--fa-flip-angle, -180deg));
            }
        }
        @keyframes fa-shake {
            0% {
                transform: rotate(-15deg);
            }
            4% {
                transform: rotate(15deg);
            }
            8%, 24% {
                transform: rotate(-18deg);
            }
            12%, 28% {
                transform: rotate(18deg);
            }
            16% {
                transform: rotate(-22deg);
            }
            20% {
                transform: rotate(22deg);
            }
            32% {
                transform: rotate(-12deg);
            }
            36% {
                transform: rotate(12deg);
            }
            40%, 100% {
                transform: rotate(0deg);
            }
        }
        @keyframes fa-spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .fa-rotate-90 {
            transform: rotate(90deg);
        }

        .fa-rotate-180 {
            transform: rotate(180deg);
        }

        .fa-rotate-270 {
            transform: rotate(270deg);
        }

        .fa-flip-horizontal {
            transform: scale(-1, 1);
        }

        .fa-flip-vertical {
            transform: scale(1, -1);
        }

        .fa-flip-both,
        .fa-flip-horizontal.fa-flip-vertical {
            transform: scale(-1, -1);
        }

        .fa-rotate-by {
            transform: rotate(var(--fa-rotate-angle, 0));
        }

        .fa-stack {
            display: inline-block;
            vertical-align: middle;
            height: 2em;
            position: relative;
            width: 2.5em;
        }

        .fa-stack-1x,
        .fa-stack-2x {
            bottom: 0;
            left: 0;
            margin: auto;
            position: absolute;
            right: 0;
            top: 0;
            z-index: var(--fa-stack-z-index, auto);
        }

        .svg-inline--fa.fa-stack-1x {
            height: 1em;
            width: 1.25em;
        }
        .svg-inline--fa.fa-stack-2x {
            height: 2em;
            width: 2.5em;
        }

        .fa-inverse {
            color: var(--fa-inverse, #fff);
        }

        .sr-only,
        .fa-sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .sr-only-focusable:not(:focus),
        .fa-sr-only-focusable:not(:focus) {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .svg-inline--fa .fa-primary {
            fill: var(--fa-primary-color, currentColor);
            opacity: var(--fa-primary-opacity, 1);
        }

        .svg-inline--fa .fa-secondary {
            fill: var(--fa-secondary-color, currentColor);
            opacity: var(--fa-secondary-opacity, 0.4);
        }

        .svg-inline--fa.fa-swap-opacity .fa-primary {
            opacity: var(--fa-secondary-opacity, 0.4);
        }

        .svg-inline--fa.fa-swap-opacity .fa-secondary {
            opacity: var(--fa-primary-opacity, 1);
        }

        .svg-inline--fa mask .fa-primary,
        .svg-inline--fa mask .fa-secondary {
            fill: black;
        }
        .route-endpoint:hover {
            border-color: #007AFF;
            cursor: pointer;
        }
        .edit-message {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .editable-select {
            transition: all 0.2s ease;
        }
        .editable-select:hover {
            border-color: #007AFF;
            cursor: pointer;
        }
        .carrier-selection {
            display: flex;
            flex-direction: column;
        }
        .carrier-selection select {
            margin-bottom: 8px;
        }
        @media (min-width: 481px) {
            .carrier-selection {
                flex-direction: row;
                align-items: flex-start;
                gap: 8px;
            }
            .carrier-selection select {
                margin-bottom: 0;
            }
            .edit-message {
                position: absolute;
                margin-top: 48px;
            }
        }
        .profile-container {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 8px;
        }

        .profile-name {
            font-size: 34px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .profile-stats {
            background: #F2F2F7;
            border-radius: 10px;
            overflow: hidden;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 11px 16px;
            background: #F2F2F7;
            position: relative;
        }

        .stat-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 16px;
            right: 16px;
            bottom: 0;
            height: 1px;
            background: rgba(60, 60, 67, 0.1);
        }

        .stat-label {
            font-size: 17px;
            color: #000000;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .stat-value {
            font-size: 17px;
            color: #000000;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Стили для админ-панели в iOS стиле */
        .admin-header {
            margin-bottom: 16px;
        }

        .admin-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: #000;
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .admin-header p {
            font-size: 15px;
            color: #8E8E93;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .admin-select {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            .profile-stats {
                background: #2C2C2E;
            }

            .stat-item {
                background: #2C2C2E;
            }

            .stat-label {
                color: #FFFFFF;
            }

            .stat-value {
                color: #FFFFFF;
            }

            .profile-name {
                color: #4f4f4f;
            }
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="constructor">
                <svg width="14" height="11" viewBox="0 0 14 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.21826 0.626873C8.70047 0.747427 8.99366 1.23607 8.8731 1.71828L6.8731 9.71828C6.75255 10.2005 6.26391 10.4937 5.78169 10.3731C5.29948 10.2526 5.00629 9.76394 5.12685 9.28172L7.12685 1.28172C7.2474 0.799504 7.73604 0.506319 8.21826 0.626873ZM4.13637 2.36361C4.48784 2.71508 4.48784 3.28493 4.13637 3.6364L2.27277 5.5L4.13637 7.36361C4.48784 7.71508 4.48784 8.28493 4.13637 8.6364C3.7849 8.98787 3.21505 8.98787 2.86358 8.6364L0.363579 6.1364C0.0121076 5.78493 0.0121076 5.21508 0.363579 4.86361L2.86358 2.36361C3.21505 2.01213 3.7849 2.01213 4.13637 2.36361ZM9.86358 2.36361C10.2151 2.01213 10.7849 2.01213 11.1364 2.36361L13.6364 4.86361C13.9878 5.21508 13.9878 5.78493 13.6364 6.1364L11.1364 8.6364C10.7849 8.98787 10.2151 8.98787 9.86358 8.6364C9.51211 8.28493 9.51211 7.71508 9.86358 7.36361L11.7272 5.5L9.86358 3.6364C9.51211 3.28493 9.51211 2.71508 9.86358 2.36361Z" fill="currentColor"/>
                </svg>
                Конструктор
            </div>
            <div class="tab" data-tab="saved">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                Сохраненные
            </div>
            <div class="tab" data-tab="verify">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
                Профиль
            </div>
        </div>

        <div class="tab-content active" id="constructor-content">
            <div class="form-group">
                <label for="routeNumber">Номер маршрута</label>
                <input type="number" id="routeNumber" min="1" max="99" placeholder="Введите номер (1-99)">
            </div>
            <div class="input-group">
                <label for="carrier">Перевозчик</label>
                <div class="carrier-selection">
                <select id="carrier" required>
                    <option value="">Выберите перевозчика</option>
                </select>
                    <button id="autoSelectCarrier" class="auto-select-btn">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z"/>
                        </svg>
                        Автовыбор
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="route">Маршрут</label>
                <div class="route-selector">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <button id="autoSelectRoute" class="auto-select-btn" style="flex: 1;">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z"/>
                            </svg>
                            Автовыбор маршрута
                        </button>
                    </div>
                    <div style="color: #8E8E93; font-size: 13px; margin-bottom: 8px;">
                        * Автовыбор работает только для автобусных маршрутов и не всегда может быть точным
                    </div>
                    <input type="hidden" id="route">
                    <select id="routeStart" class="route-endpoint">
                        <option value="">Начальная остановка</option>
                    </select>
                    <button id="reverseRoute" class="reverse-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M7.5 21.5l1.5-1.5-4.5-4.5H21v-2H4.5l4.5-4.5-1.5-1.5L1 14l6.5 7.5zm9-19l-1.5 1.5 4.5 4.5H3v2h16.5l-4.5 4.5 1.5 1.5L23 10l-6.5-7.5z"/>
                        </svg>
                    </button>
                    <select id="routeEnd" class="route-endpoint">
                        <option value="">Конечная остановка</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="vehicle">Гос. номер</label>
                <input type="text" id="vehicle" placeholder="Например: р471тм124">
            </div>
            <div class="form-group">
                <label for="quantity">Количество билетов</label>
                <div class="custom-slider" id="quantity-slider-container">
                    <div class="slider-rail"></div>
                    <div class="slider-track"></div>
                    <div class="slider-dots">
                        <span class="slider-dot active" style="left: 0%"></span>
                        <span class="slider-dot" style="left: 25%"></span>
                        <span class="slider-dot" style="left: 50%"></span>
                        <span class="slider-dot" style="left: 75%"></span>
                        <span class="slider-dot" style="left: 100%"></span>
                    </div>
                    <div class="slider-handle" style="left: 0%"></div>
                    <div class="slider-marks">
                        <span class="slider-mark active" style="left: 0%">1</span>
                        <span class="slider-mark" style="left: 25%">2</span>
                        <span class="slider-mark" style="left: 50%">3</span>
                        <span class="slider-mark" style="left: 75%">4</span>
                        <span class="slider-mark" style="left: 100%">5</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="cost">Стоимость</label>
                <div class="cost-selector">
                    <label class="cost-option">
                        <input type="radio" name="cost" value="35.00" checked>
                        <span>35.00₽</span>
                    </label>
                    <label class="cost-option">
                        <input type="radio" name="cost" value="31.00">
                        <span>31.00₽</span>
                    </label>
                </div>
            </div>
            <button id="createTicketBtn">Создать билет</button>
        </div>

        <div class="tab-content" id="saved-content">
            <div id="saved-tickets-list" class="saved-tickets"></div>
        </div>

        <div class="tab-content" id="verify-content">
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-name"></div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-label">Создано билетов</span>
                        <span id="ticketsCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Последний билет</span>
                        <span id="lastTicketDate">-</span>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" style="display: none;">
                    <div class="admin-header">Панель администратора</div>
                    <select id="userSelect" class="admin-select">
                        <option value="">Выберите пользователя</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="delete-confirmation">
        <div class="modal">
            <div class="modal-title">Вы уверены, что хотите удалить этот билет?</div>
            <div class="modal-actions">
                <button class="modal-btn modal-cancel">Отмена</button>
                <button class="modal-btn modal-confirm">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
            // Устанавливаем белый цвет для заголовка
            tg.setHeaderColor('#ffffff');
        } catch (error) {
            console.error('Error initializing Telegram Web App:', error);
            tg = {
                initDataUnsafe: { user: { id: 'test_user' } },
                close: () => console.log('Close called'),
                expand: () => console.log('Expand called'),
                ready: () => console.log('Ready called'),
                setHeaderColor: () => console.log('SetHeaderColor called')
            };
        }

        const userId = tg.initDataUnsafe?.user?.id || 'unknown';
        
        async function checkAccess() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/users_data.json');
                const data = await response.json();
                
                const currentUserId = tg.initDataUnsafe?.user?.id?.toString();
                const currentUsername = tg.initDataUnsafe?.user?.username;

                console.log('Current User ID:', currentUserId);
                console.log('Current Username:', currentUsername);
                console.log('Allowed Users:', data.allowed_users);
                console.log('Users List:', data.users);

                if (data.allowed_users.includes(currentUserId)) {
                    console.log('Access granted by ID');
                    return true;
                }

                if (currentUsername) {
                    const foundUser = Object.entries(data.users).find(([_, userInfo]) => 
                        userInfo.username?.toLowerCase() === currentUsername.toLowerCase()
                    );

                    if (foundUser) {
                        const [userId, _] = foundUser;
                        if (data.allowed_users.includes(userId)) {
                            console.log('Access granted by username');
                            return true;
                        }
                    }
                }

                console.log('Access denied');
                alert('У вас нет доступа к этому приложению');
                tg.close();
                return false;
            } catch (error) {
                console.error('Error checking access:', error);
                alert('Ошибка при проверке доступа');
                tg.close();
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const hasAccess = await checkAccess();
            if (!hasAccess) {
                document.getElementById('constructor-content').style.display = 'none';
                document.getElementById('saved-content').style.display = 'none';
                return;
            }
            
            populateCarrierDropdown();
            populateRouteEndpoints();
        });

        const createTicketBtn = document.getElementById('createTicketBtn');
        createTicketBtn.addEventListener('click', async function() {
            const hasAccess = await checkAccess();
            if (!hasAccess) {
                return;
            }
            
            const routeNumber = document.getElementById('routeNumber').value;
            const carrier = document.getElementById('carrier').value;
            const startValue = document.getElementById('routeStart').value;
            const endValue = document.getElementById('routeEnd').value;
            const route = `${startValue} - ${endValue}`;
            const vehicle = document.getElementById('vehicle').value;
            const sliderHandle = document.querySelector('.slider-handle');
            const handlePosition = parseInt(sliderHandle.style.left);
            const quantity = Math.floor(handlePosition / 25) + 1;
            const baseCost = document.querySelector('input[name="cost"]:checked').value;
            const totalCost = (parseFloat(baseCost) * quantity).toFixed(2);

            if (!routeNumber || !carrier || !startValue || !endValue || !vehicle) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            if (routeNumber < 1 || routeNumber > 99) {
                alert('Номер маршрута должен быть от 1 до 99');
                return;
            }

            const ticketCode = generateRandomTicketNumber();
            
            const ticket = {
                routeNumber,
                carrier,
                route,
                vehicle,
                quantity,
                cost: totalCost,
                baseCost: baseCost,
                code: ticketCode,
                date: new Date().toISOString()
            };

            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            
            savedTickets.unshift(ticket);
            
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

            const params = new URLSearchParams();
            params.append('userId', userId);
            params.append('routeNumber', routeNumber);
            params.append('carrier', carrier);
            params.append('route', route);
            params.append('vehicle', vehicle);
            params.append('quantity', quantity);
            params.append('cost', totalCost);
            params.append('baseCost', baseCost);
            params.append('code', ticketCode);
            
            window.location.href = 'https://competidora-cmd.github.io/telegram-mini-app/ticket.html?' + params.toString();
        });

        const routesData = {
            "routes": {
                "3": {
                    "name": "Маршрут 3",
                    "carriers": ["ИП Патрин Н.Н.", "ООО \"СТК\""]
                },
                "99": {
                    "name": "Маршрут 99",
                    "carriers": ["ООО \"СТК\"", "ИП Патрин Н.Н"]
                }
            },
            "allCarriers": [
                "ИП Багаев Д.Б.",
                "ИП Галченкова Е.А.",
                "ООО «Экипаж-ГО»",
                "ИП Долгушина Г.И.",
                "ИП Тагачаков В.Г.",
                "ООО \"Перевозчик\"",
                "ООО \"СКАД\"",
                "КПАТП-7",
                "КПАТП-5",
                "ООО \"Ветеран\"",
                "ИП Ялтонский А.М.",
                "ИП Читашвили Н.С.",
                "ООО \"Вавулин - К\"",
                "ИП Кривоногов И.Г.",
                "ИП Голунцов С.В.",
                "ИП Цугленок М.М.",
                "ООО «КПАТП»",
                "ИП Галченкова О.Г.",
                "ООО \"Практик\"",
                "ООО \"Сибирь-Авто\"",
                "ИП Бронников А.И.",
                "ИП Бронников М.А.",
                "ИП Долгушин Д.Г.",
                "ООО \"Сирена\"",
                "ИП Патрин Н.Н.",
                "ООО \"МаршрутАвто\"",
                "ИП Карасева Н.Н.",
                "ИП Гнетов Ю.Н.",
                "МП Городской Транспорт",
                "АО \"СТК\"",
            ]
        };

        function populateCarrierDropdown() {
            const carriers = routesData.allCarriers;
            const carrierSelect = document.getElementById('carrier');
            
            carrierSelect.innerHTML = '';
            
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Выберите перевозчика';
            carrierSelect.appendChild(emptyOption);
            
            carriers.forEach(carrier => {
                const option = document.createElement('option');
                option.value = carrier;
                option.textContent = carrier;
                carrierSelect.appendChild(option);
            });
        }

        async function updateCarrierBasedOnRoute() {
            const routeNumber = document.getElementById('routeNumber').value;
            const carrierSelect = document.getElementById('carrier');
            
            if (!routeNumber) return;
            
            const data = await fetchRoutesData();
            const route = data.routes[routeNumber];
            
            if (route && route.carriers && route.carriers.length > 0) {
                    carrierSelect.innerHTML = '';
                    
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Выберите перевозчика для маршрута ' + routeNumber;
                    carrierSelect.appendChild(emptyOption);
                    
                    route.carriers.forEach(carrier => {
                        const option = document.createElement('option');
                        option.value = carrier;
                        option.textContent = carrier;
                        carrierSelect.appendChild(option);
                    });
                
                if (route.carriers.length === 1) {
                    carrierSelect.value = route.carriers[0];
                }
            } else {
                populateCarrierDropdown();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            populateCarrierDropdown();
            document.getElementById('routeNumber').addEventListener('change', updateCarrierBasedOnRoute);
        });

        function generateRandomTicketNumber() {
            const prefix = 61;
            const baseNumber = 1061533078;
            const randomIncrement = Math.floor(Math.random() * 1000000);
            const num = (baseNumber + randomIncrement).toString();
            return num.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }

        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year} г.`;
        }

        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        function loadSavedTickets() {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const container = document.getElementById('saved-tickets-list');
            container.innerHTML = '';

            savedTickets.forEach((ticket, index) => {
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-item';
                ticketElement.innerHTML = `
                    <div class="ticket-info">
                        <div class="ticket-details">
                            <div class="ticket-number">${ticket.code}</div>
                            <div class="ticket-route">${ticket.routeNumber} ${ticket.route}</div>
                        </div>
                        <div class="ticket-actions">
                            <button class="edit-btn" onclick="toggleEditForm(${index})">Изменить</button>
                            <button class="open-btn" onclick="openSavedTicket(${index})">Открыть</button>
                            <button class="delete-btn" onclick="confirmDeleteTicket(${index})">Удалить</button>
                        </div>
                    </div>
                    <div class="edit-form" id="edit-form-${index}">
                        <input type="number" class="edit-field" id="edit-routeNumber-${index}" 
                               value="${ticket.routeNumber}" 
                               min="1" max="99"
                               placeholder="Номер маршрута (1-99)">
                        <input type="text" class="edit-field" id="edit-carrier-${index}" 
                               value="${ticket.carrier}" 
                               placeholder="Например: ИП Патрин Н. Н.">
                        <input type="text" class="edit-field" id="edit-route-${index}" 
                               value="${ticket.route}" 
                               placeholder="Например: Красфарма (60 лет Октября) - Х/К Енисей">
                        <input type="text" class="edit-field" id="edit-vehicle-${index}" 
                               value="${ticket.vehicle}" 
                               placeholder="Например: р471тм124">
                        <input type="range" class="edit-field" id="edit-quantity-slider-${index}" min="1" max="5" value="${ticket.quantity}" step="1" oninput="updateEditQuantityDisplay(${index}, this.value)">
                        <div id="edit-quantity-display-${index}">${ticket.quantity} ${ticket.quantity === '1' ? 'билет' : 'билета'}</div>
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveEditedTicket(${index})">Сохранить</button>
                            <button class="cancel-btn" onclick="toggleEditForm(${index})">Отмена</button>
                        </div>
                    </div>
                `;
                container.appendChild(ticketElement);

                const editFormInputs = document.querySelectorAll(`#edit-form-${index} input[type="text"], #edit-form-${index} input[type="number"]`);
                editFormInputs.forEach(input => {
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                });
            });

            document.addEventListener('click', function(e) {
                const activeElement = document.activeElement;
                if (activeElement && 
                    !e.target.matches('input[type="text"], input[type="number"]') &&
                    !e.target.matches('select, select *') &&
                    (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
                    activeElement.blur();
                }
            });
        }

        function openSavedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];
            const params = new URLSearchParams();
            
            const newTicketCode = generateRandomTicketNumber();
            
            const quantity = parseInt(ticket.quantity || 1);
            let baseCost;
            
            if (ticket.baseCost) {
                baseCost = parseFloat(ticket.baseCost);
            } else {
                baseCost = parseFloat(ticket.cost) / quantity;
            }
            
            const totalCost = (baseCost * quantity).toFixed(2);
            
            params.append('userId', userId);
            params.append('routeNumber', ticket.routeNumber);
            params.append('carrier', ticket.carrier);
            params.append('route', ticket.route);
            params.append('vehicle', ticket.vehicle);
            params.append('quantity', quantity);
            params.append('cost', totalCost);
            params.append('baseCost', baseCost.toFixed(2));
            params.append('code', newTicketCode);
            
            if (ticket.date) {
                params.append('date', ticket.date);
            }

            ticket.code = newTicketCode;
            savedTickets[index] = ticket;
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

            window.location.href = 'ticket.html?' + params.toString();
        }

        function toggleEditForm(index) {
            const form = document.getElementById(`edit-form-${index}`);
            form.classList.toggle('active');
        }

        function saveEditedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];

            const routeNumber = document.getElementById(`edit-routeNumber-${index}`).value;
            if (routeNumber < 1 || routeNumber > 99) {
                alert('Номер маршрута должен быть от 1 до 99');
                return;
            }

            const newCarrier = document.getElementById(`edit-carrier-${index}`).value;
            const newQuantity = parseInt(document.getElementById(`edit-quantity-slider-${index}`).value);
            
            ticket.routeNumber = routeNumber;
            ticket.carrier = newCarrier;
            ticket.route = document.getElementById(`edit-route-${index}`).value;
            ticket.vehicle = document.getElementById(`edit-vehicle-${index}`).value;
            ticket.quantity = newQuantity;
            
            let baseCost;
            if (ticket.baseCost) {
                baseCost = parseFloat(ticket.baseCost);
            } else {
                baseCost = 35.00;
            }
            
            const totalCost = (baseCost * newQuantity).toFixed(2);
            ticket.cost = totalCost;

            savedTickets[index] = ticket;
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
            loadSavedTickets();
            toggleEditForm(index);
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-content').classList.add('active');
                
                if (tab.dataset.tab === 'saved') {
                    loadSavedTickets();
                }
            });
        });

        if (document.querySelector('.tab[data-tab="saved"]').classList.contains('active')) {
            loadSavedTickets();
        }

        const routeEndpoints = [
            "ЛДК",
            "ТЭЦ-3",
            'ОАО "Русал"',
            "мкрн. Верхние черёмушки",
            "Академия биатлона",
            "мкрн. Тихие Зори",
            "Ст. Красноярск-Северный",
            "Стела",
            "мкрн. Солнечный",
            "Спортзал",
            "Озеро-парк",
            "Красфарма (60 лет Октября)",
            "Контейнерный двор",
            "Химкомбинат Енисей",
            "пос. Зыково",
            "пос. Таймыр",
            "Ж/Д Вокзал",
            "Причал",
            "А/В Восточный",
            "Дом учёных",
            "Верхняя базаиха",
            "С/О Южное",
            "Сельхозкомплекс",
            "ДК Кировский",
            "Агротерминал",
            "Междугородный вокзал",
            'Спорткомплекс "Радуга"',
            "ОАО Красфарма",
            "Парашютная",
            "Госпиталь ВОВ",
            "пос. Энергетиков",
            "Северный",
            "Цимлянская",
            "Планета (ул. 9 Мая)",
            "Фанпарк Бобровый лог",
            "с/х Удачный",
            "ж/к Ясный",
            "ИТК",
            "мкрн.Солнечный (ул. Светлова)",
            "Ж/Д больница",
            "Шинное кладбище",
            "Профилакторий з-да КраМЗ",
            "Парк Прищепка",
            "пос. Овинный",
            "Плодово-ягодная станция"
        ];

        function populateRouteEndpoints() {
            const startSelect = document.getElementById('routeStart');
            const endSelect = document.getElementById('routeEnd');
            
            startSelect.innerHTML = '<option value="">Начальная остановка</option>';
            endSelect.innerHTML = '<option value="">Конечная остановка</option>';
            
            routeEndpoints.forEach(endpoint => {
                const startOption = document.createElement('option');
                const endOption = document.createElement('option');
                
                startOption.value = endpoint;
                startOption.textContent = endpoint;
                endOption.value = endpoint;
                endOption.textContent = endpoint;
                
                startSelect.appendChild(startOption);
                endSelect.appendChild(endOption);
            });
        }

        document.getElementById('reverseRoute').addEventListener('click', function() {
            const startSelect = document.getElementById('routeStart');
            const endSelect = document.getElementById('routeEnd');
            
            const tempValue = startSelect.value;
            startSelect.value = endSelect.value;
            endSelect.value = tempValue;
            
            updateRouteDisplay();
        });

        function updateRouteDisplay() {
            const startValue = document.getElementById('routeStart').value;
            const endValue = document.getElementById('routeEnd').value;
            
            if (startValue && endValue) {
                document.getElementById('route').value = `${startValue} - ${endValue}`;
            }
        }

        document.getElementById('routeStart').addEventListener('change', updateRouteDisplay);
        document.getElementById('routeEnd').addEventListener('change', updateRouteDisplay);

        document.addEventListener('DOMContentLoaded', function() {
            populateRouteEndpoints();
        });

        function confirmDeleteTicket(index) {
            const modalBackdrop = document.getElementById('delete-confirmation');
            const modal = document.querySelector('.modal');
            const deleteBtn = document.querySelector('.delete-btn');
            const cancelBtn = document.querySelector('.modal-cancel');
            const confirmBtn = document.querySelector('.modal-confirm');

            modalBackdrop.style.display = 'flex';
            modal.style.display = 'block';

            cancelBtn.addEventListener('click', function() {
                modalBackdrop.style.display = 'none';
                modal.style.display = 'none';
            });

            confirmBtn.addEventListener('click', function() {
                const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
                savedTickets.splice(index, 1);
                localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
                loadSavedTickets();
                modalBackdrop.style.display = 'none';
                modal.style.display = 'none';
            });
        }

        function updateEditQuantityDisplay(index, value) {
            document.getElementById(`edit-quantity-display-${index}`).textContent = `${value} ${value === '1' ? 'билет' : 'билета'}`;
        }

        const quantitySlider = document.getElementById('quantity-slider-container');
        quantitySlider.addEventListener('click', function(event) {
            const rect = quantitySlider.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = (x / rect.width) * 100;
            updateSlider(percentage);
        });

        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
                    inputs.forEach(input => {
                        input.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                input.blur();
                            }
                });
            });

            document.addEventListener('click', function(e) {
                const activeElement = document.activeElement;
                if (activeElement && 
                    !e.target.matches('select, select *') &&
                    !e.target.matches('input[type="text"], input[type="number"]') &&
                    (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
                    activeElement.blur();
                }
            });
        });

        const selectElements = document.querySelectorAll('select');
        selectElements.forEach(select => {
            select.style.webkitAppearance = 'none';
            select.style.appearance = 'none';
            select.style.backgroundImage = `url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            select.style.backgroundRepeat = 'no-repeat';
            select.style.backgroundPosition = 'right 16px center';
            select.style.paddingRight = '40px';
        });

        document.addEventListener('DOMContentLoaded', function() {
            const sliderContainer = document.getElementById('quantity-slider-container');
            const handle = sliderContainer.querySelector('.slider-handle');
            const track = sliderContainer.querySelector('.slider-track');
            const quantityInput = document.getElementById('quantity-input');
            const quantityDisplay = document.getElementById('quantity-display');
            const dots = sliderContainer.querySelectorAll('.slider-dot');
            const marks = sliderContainer.querySelectorAll('.slider-mark');
            let isDragging = false;

            function updateSlider(percentage) {
                const steps = [0, 25, 50, 75, 100];
                const closestStep = steps.reduce((prev, curr) => 
                    Math.abs(curr - percentage) < Math.abs(prev - percentage) ? curr : prev
                );

                handle.style.left = `${closestStep}%`;
                track.style.width = `${closestStep}%`;

                const quantity = (closestStep / 25) + 1;
                quantityInput.value = quantity;
                quantityDisplay.textContent = `${quantity} ${quantity === 1 ? 'билет' : 'билета'}`;

                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index * 25 <= closestStep);
                });
                marks.forEach((mark, index) => {
                    mark.classList.toggle('active', index * 25 <= closestStep);
                });
            }

            function handleMove(event) {
                if (!isDragging) return;
                
                const rect = sliderContainer.getBoundingClientRect();
                const x = event.type.includes('touch') ? 
                    event.touches[0].clientX - rect.left :
                    event.clientX - rect.left;
                
                let percentage = (x / rect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                
                updateSlider(percentage);
            }

            function handleStart(event) {
                isDragging = true;
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('touchmove', handleMove);
                document.addEventListener('mouseup', handleEnd);
                document.addEventListener('touchend', handleEnd);
            }

            function handleEnd() {
                isDragging = false;
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('touchmove', handleMove);
                document.removeEventListener('mouseup', handleEnd);
                document.removeEventListener('touchend', handleEnd);
            }

            sliderContainer.addEventListener('click', function(event) {
                const rect = sliderContainer.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const percentage = (x / rect.width) * 100;
                updateSlider(percentage);
            });

            handle.addEventListener('mousedown', handleStart);
            handle.addEventListener('touchstart', handleStart);

            updateSlider(0);
        });

        async function fetchRoutesData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/routes.json');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching routes data:', error);
                return routesData;
            }
        }

        document.getElementById('autoSelectCarrier').addEventListener('click', async function() {
            const routeNumber = document.getElementById('routeNumber').value;
            if (!routeNumber) {
                alert('Сначала выберите номер маршрута');
                return;
            }
            
            const data = await fetchRoutesData();
            const route = data.routes[routeNumber];
            const carrierSelect = document.getElementById('carrier');
            const carrierSelection = document.querySelector('.carrier-selection');
            
            // Сначала заполняем полный список перевозчиков
            populateCarrierDropdown();
            
            if (route && route.carriers && route.carriers.length > 0) {
                // Если есть только один перевозчик для маршрута, выбираем его
                if (route.carriers.length === 1) {
                    carrierSelect.value = route.carriers[0];
                }
                
                // Добавляем подсказку о возможности изменения
                const existingMessage = carrierSelection.querySelector('.edit-message');
                if (!existingMessage) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'edit-message';
                    messageDiv.style.color = '#007AFF';
                    messageDiv.style.fontSize = '13px';
                    messageDiv.style.marginTop = '8px';
                    messageDiv.style.marginBottom = '8px';
                    messageDiv.innerHTML = '✏️ Вы можете выбрать другого перевозчика из списка';
                    carrierSelection.appendChild(messageDiv);
                }
                
                // Добавляем эффект при наведении на select
                carrierSelect.classList.add('editable-select');
            } else {
                alert('Для этого маршрута нет рекомендуемых перевозчиков, но вы можете выбрать любого из списка');
            }
        });

        async function autoSelectRoute() {
            const routeNumber = document.getElementById('routeNumber').value;
            
            if (!routeNumber) {
                alert('Пожалуйста, сначала выберите номер маршрута');
                return;
            }

            try {
                const response = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/route.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                if (data.routes[routeNumber]) {
                    const route = data.routes[routeNumber];
                    const startSelect = document.getElementById('routeStart');
                    const endSelect = document.getElementById('routeEnd');
                    
                    function ensureOption(select, value) {
                        let option = Array.from(select.options).find(opt => opt.value === value);
                        if (!option) {
                            option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            select.appendChild(option);
                        }
                        return option;
                    }
                    
                    if (route.start) {
                        ensureOption(startSelect, route.start);
                        startSelect.value = route.start;
                    }
                    
                    if (route.end) {
                        ensureOption(endSelect, route.end);
                        endSelect.value = route.end;
                    }
                    
                    document.getElementById('route').value = `${route.start} - ${route.end}`;

                    // Добавляем подсказку о возможности редактирования
                    const messageDiv = document.createElement('div');
                    messageDiv.style.color = '#007AFF';
                    messageDiv.style.fontSize = '13px';
                    messageDiv.style.marginTop = '8px';
                    messageDiv.style.marginBottom = '8px';
                    messageDiv.innerHTML = '✏️ Вы можете изменить маршрут вручную, если данные неверны';
                    
                    const routeSelector = document.querySelector('.route-selector');
                    const existingMessage = routeSelector.querySelector('.edit-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    messageDiv.className = 'edit-message';
                    routeSelector.insertBefore(messageDiv, document.getElementById('routeStart').parentNode);

                    // Делаем поля активными и доступными для редактирования
                    startSelect.disabled = false;
                    endSelect.disabled = false;
                    
                } else {
                    alert('Маршрут не найден. Пожалуйста, выберите маршрут вручную.');
                }
            } catch (error) {
                console.error('Error fetching route data:', error);
                alert('Ошибка при получении данных о маршруте. Пожалуйста, выберите маршрут вручную.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            populateRouteEndpoints();
            const autoSelectRouteBtn = document.getElementById('autoSelectRoute');
            if (autoSelectRouteBtn) {
                autoSelectRouteBtn.addEventListener('click', autoSelectRoute);
            }
        });

        document.getElementById('verifyCodeBtn').addEventListener('click', async function() {
            const code = document.getElementById('verifyCode').value.trim();
            const resultDiv = document.getElementById('verifyResult');
            
            if (!code || !/^\d{6}$/.test(code)) {
                resultDiv.className = 'verify-result error';
                resultDiv.textContent = 'Пожалуйста, введите 6-значный код';
                resultDiv.style.display = 'block';
                return;
            }

            try {
                const baseCodeResponse = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/base_code.json');
                if (!baseCodeResponse.ok) {
                    throw new Error('Ошибка при загрузке базы кодов');
                }
                const baseCodeData = await baseCodeResponse.json();
                
                const codeEntry = baseCodeData.codes.find(entry => entry.code === code);
                if (!codeEntry) {
                    resultDiv.className = 'verify-result error';
                    resultDiv.textContent = 'Код не найден в базе данных';
                    resultDiv.style.display = 'block';
                    return;
                }

                const routeNumber = codeEntry.route;
                const vehicleNumber = codeEntry.vehicle_number;

                const routeResponse = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/route.json');
                if (!routeResponse.ok) {
                    throw new Error('Ошибка при загрузке информации о маршруте');
                }
                const routeData = await routeResponse.json();
                
                const routeInfo = routeData.routes[routeNumber];
                if (!routeInfo) {
                    throw new Error('Информация о маршруте не найдена');
                }

                const routesResponse = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/routes.json');
                if (!routesResponse.ok) {
                    throw new Error('Ошибка при загрузке информации о перевозчиках');
                }
                const routesData = await routesResponse.json();
                
                const routeCarriers = routesData.routes[routeNumber]?.carriers || [];
                const carrier = routeCarriers[0] || 'Перевозчик не указан';

                const ticketData = {
                    routeNumber: routeNumber,
                    carrier: carrier,
                    route: `${routeInfo.start} - ${routeInfo.end}`,
                    vehicle: vehicleNumber,
                    quantity: 1,
                    cost: "44.00",
                    baseCost: "44.00",
                    code: generateRandomTicketNumber(),
                    date: new Date().toISOString()
                };

                const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
                savedTickets.unshift(ticketData);
                localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

                const params = new URLSearchParams();
                Object.entries(ticketData).forEach(([key, value]) => {
                    params.append(key, value);
                });
                params.append('userId', userId);

                window.location.href = 'ticket.html?' + params.toString();

            } catch (error) {
                console.error('Error creating ticket:', error);
                resultDiv.className = 'verify-result error';
                resultDiv.textContent = 'Произошла ошибка: ' + error.message;
                resultDiv.style.display = 'block';
            }
        });

        document.getElementById('verifyCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '').slice(0, 6);
        });

        // Инициализация Firebase
        const firebaseConfig = {
            projectId: "city-transport-7bf5d",
            clientEmail: "firebase-adminsdk-fbsvc@city-transport-7bf5d.iam.gserviceaccount.com",
        };

        // Функция для сохранения данных в Firebase
        async function saveUserData(ticketData) {
            try {
                const userId = tg.initDataUnsafe?.user?.id?.toString();
                if (!userId) {
                    console.error('User ID not found');
                    return;
                }

                // Получаем текущие данные пользователя
                const response = await fetch(`https://city-transport-7bf5d.firebaseio.com/users/${userId}.json`);
                const userData = await response.json();

                const currentTime = new Date().toISOString();
                const updatedData = {
                    userId: userId,
                    username: tg.initDataUnsafe?.user?.username || 'anonymous',
                    lastTicketDate: currentTime,
                    ticketsCount: (userData?.ticketsCount || 0) + 1,
                    lastTicket: ticketData
                };

                // Сохраняем обновленные данные
                const saveResponse = await fetch(`https://city-transport-7bf5d.firebaseio.com/users/${userId}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify(updatedData)
                });

                if (!saveResponse.ok) {
                    throw new Error('Failed to save user data');
                }

                // Обновляем отображение профиля
                await updateProfileData();

            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Функция для загрузки списка пользователей (для админ-панели)
        async function loadUsersList() {
            try {
                const response = await fetch('https://city-transport-7bf5d.firebaseio.com/users.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch users data');
                }

                const users = await response.json();
                const userSelect = document.getElementById('userSelect');
                
                // Очищаем текущий список
                userSelect.innerHTML = '<option value="">Выберите пользователя</option>';
                
                // Сортируем пользователей по убыванию количества билетов
                const sortedUsers = Object.entries(users)
                    .sort(([, a], [, b]) => (b.ticketsCount || 0) - (a.ticketsCount || 0));

                // Добавляем пользователей в список
                for (const [userId, userData] of sortedUsers) {
                    const option = document.createElement('option');
                    option.value = userId;
                    const username = userData.username || `User ${userId}`;
                    const ticketCount = userData.ticketsCount || 0;
                    option.textContent = `${username} (Билетов: ${ticketCount})`;
                    userSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading users list:', error);
            }
        }

        // Обновляем функцию создания билета
        const originalCreateTicketBtn = document.getElementById('createTicketBtn').onclick;
        document.getElementById('createTicketBtn').onclick = async function() {
            const ticketData = {
                routeNumber: document.getElementById('routeNumber').value,
                carrier: document.getElementById('carrier').value,
                route: `${document.getElementById('routeStart').value} - ${document.getElementById('routeEnd').value}`,
                vehicle: document.getElementById('vehicle').value,
                quantity: parseInt(document.querySelector('.slider-handle').style.left) / 25 + 1,
                cost: document.querySelector('input[name="cost"]:checked').value,
                date: new Date().toISOString()
            };

            // Сохраняем данные в Firebase
            await saveUserData(ticketData);
            
            // Вызываем оригинальную функцию создания билета
            await originalCreateTicketBtn.call(this);
            
            // Обновляем данные профиля
            updateProfileData();
        };

        // Обновляем функцию получения данных профиля
        async function updateProfileData() {
            try {
                const userNameElement = document.getElementById('userName');
                const ticketsCountElement = document.getElementById('ticketsCount');
                const lastTicketDateElement = document.getElementById('lastTicketDate');
                const adminPanel = document.getElementById('adminPanel');

                // Проверяем, является ли текущий пользователь администратором
                const isAdminUser = await checkAdmin();
                if (isAdminUser) {
                    adminPanel.style.display = 'block';
                    await loadUsersList();
                } else {
                    adminPanel.style.display = 'none';
                }

                // Определяем, чью статистику показывать
                const targetUserId = tg.initDataUnsafe?.user?.id;

                // Получаем данные пользователя
                const response = await fetch(`https://city-transport-7bf5d.firebaseio.com/users/${targetUserId}.json`);
                const userData = await response.json();

                if (userData) {
                    // Получаем имя пользователя из Telegram или из базы данных
                    const displayName = userData.username || `User ${targetUserId}`;

                    // Устанавливаем имя пользователя
                    userNameElement.textContent = displayName;
                    
                    // Устанавливаем статистику
                    ticketsCountElement.textContent = userData.ticketsCount || 0;
                    if (userData.lastTicketDate) {
                        const lastTicketDate = new Date(userData.lastTicketDate);
                        lastTicketDateElement.textContent = `${lastTicketDate.toLocaleDateString('ru-RU')} ${lastTicketDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
                    } else {
                        lastTicketDateElement.textContent = '-';
                    }
                }
            } catch (error) {
                console.error('Error updating profile:', error);
            }
        }

        // Вызываем обновление профиля при загрузке страницы
        document.addEventListener('DOMContentLoaded', updateProfileData);

        // Список администраторов
        const adminUsers = [
            "5534462537", // Добавьте сюда ID администраторов
        ];

        // Функция проверки является ли пользователь администратором
        function isAdmin() {
            const userId = tg.initDataUnsafe?.user?.id?.toString();
            return adminUsers.includes(userId);
        }

        // Обновляем функцию updateProfileData для поддержки админ-функционала
        async function updateProfileData(selectedUserId = null) {
            try {
                const userNameElement = document.getElementById('userName');
                const ticketsCountElement = document.getElementById('ticketsCount');
                const lastTicketDateElement = document.getElementById('lastTicketDate');
                const adminPanel = document.getElementById('adminPanel');

                // Проверяем, является ли текущий пользователь администратором
                const isAdminUser = await checkAdmin();
                console.log('Is admin user:', isAdminUser);
                
                if (isAdminUser) {
                    adminPanel.style.display = 'block';
                    await loadUsersList();
                } else {
                    adminPanel.style.display = 'none';
                }

                // Определяем, чью статистику показывать
                const targetUserId = selectedUserId || tg.initDataUnsafe?.user?.id;
                const username = tg.initDataUnsafe?.user?.username;
                
                console.log('Target user ID:', targetUserId);
                console.log('Username:', username);

                // Устанавливаем имя пользователя сразу из Telegram данных
                userNameElement.textContent = username || 'Пользователь';

                // Получаем данные из Firebase
                if (targetUserId) {
                    const response = await fetch(`https://city-transport-7bf5d.firebaseio.com/users/${targetUserId}.json`);
                    const userData = await response.json();
                    console.log('User data from Firebase:', userData);

                    if (userData) {
                        // Обновляем статистику
                        ticketsCountElement.textContent = userData.ticketsCount || 0;
                        if (userData.lastTicketDate) {
                            const lastTicketDate = new Date(userData.lastTicketDate);
                            lastTicketDateElement.textContent = `${lastTicketDate.toLocaleDateString('ru-RU')} ${lastTicketDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
                        } else {
                            lastTicketDateElement.textContent = '-';
                        }
                    } else {
                        ticketsCountElement.textContent = '0';
                        lastTicketDateElement.textContent = '-';
                    }
                }
            } catch (error) {
                console.error('Error updating profile:', error);
            }
        }

        // Добавляем обработчик события изменения выбранного пользователя
        document.addEventListener('DOMContentLoaded', function() {
            const userSelect = document.getElementById('userSelect');
            if (userSelect) {
                userSelect.addEventListener('change', async function() {
                    const selectedUserId = this.value;
                    if (selectedUserId) {
                        await updateProfileData(selectedUserId);
                    } else {
                        // Если не выбран пользователь, показываем данные текущего пользователя
                        await updateProfileData();
                    }
                });
            }
            
            // Инициализируем профиль при загрузке страницы
            updateProfileData();
        });

        // Список администраторов
        async function checkAdmin() {
            try {
                const currentUserId = tg.initDataUnsafe?.user?.id?.toString();
                const currentUsername = tg.initDataUnsafe?.user?.username;
                
                console.log('Checking admin status for:', {
                    userId: currentUserId,
                    username: currentUsername
                });

                // Прямая проверка на конкретного администратора
                if (currentUserId === "5534462537" || currentUsername?.toLowerCase() === "competidora") {
                    console.log('Admin access granted');
                    return true;
                }

                console.log('Admin access denied');
                return false;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Обновляем функцию updateProfileData для поддержки админ-функционала
        async function updateProfileData(selectedUserId = null) {
            try {
                const userNameElement = document.getElementById('userName');
                const ticketsCountElement = document.getElementById('ticketsCount');
                const lastTicketDateElement = document.getElementById('lastTicketDate');
                const adminPanel = document.getElementById('adminPanel');

                // Проверяем, является ли текущий пользователь администратором
                const isAdminUser = await checkAdmin();
                console.log('Is admin user:', isAdminUser);
                
                if (isAdminUser) {
                    console.log('Showing admin panel');
                    adminPanel.style.display = 'block';
                    await loadUsersList();
                } else {
                    console.log('Hiding admin panel');
                    adminPanel.style.display = 'none';
                }

                // Определяем, чью статистику показывать
                const targetUserId = selectedUserId || tg.initDataUnsafe?.user?.id;
                const username = tg.initDataUnsafe?.user?.username;
                
                // Устанавливаем имя пользователя сразу из Telegram данных
                if (username) {
                    userNameElement.textContent = username;
                    console.log('Setting username:', username);
                }

                // Получаем данные из Firebase
                if (targetUserId) {
                    const response = await fetch(`https://city-transport-7bf5d.firebaseio.com/users/${targetUserId}.json`);
                    const userData = await response.json();
                    console.log('User data from Firebase:', userData);

                    if (userData) {
                        // Обновляем статистику
                        ticketsCountElement.textContent = userData.ticketsCount || '0';
                        if (userData.lastTicketDate) {
                            const lastTicketDate = new Date(userData.lastTicketDate);
                            lastTicketDateElement.textContent = `${lastTicketDate.toLocaleDateString('ru-RU')} ${lastTicketDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
                        } else {
                            lastTicketDateElement.textContent = '-';
                        }
                    } else {
                        ticketsCountElement.textContent = '0';
                        lastTicketDateElement.textContent = '-';
                    }
                }
            } catch (error) {
                console.error('Error updating profile:', error);
            }
        }

        // Вызываем обновление профиля при загрузке страницы и после каждого создания билета
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Инициализация вкладок
            tabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    // Убираем активный класс со всех вкладок
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс выбранной вкладке
                    tab.classList.add('active');
                    const content = document.getElementById(tab.dataset.tab + '-content');
                    if (content) {
                        content.classList.add('active');
                        
                        // Инициализируем профиль при переключении на вкладку verify
                        if (tab.dataset.tab === 'verify') {
                            await initializeProfile();
                        }
                    }
                });
            });

            // Инициализируем профиль при загрузке страницы
            initializeProfile();
        });

        async function initializeProfile() {
            try {
                console.log('Initializing profile...');
                
                // Получаем данные пользователя из Telegram
                const userId = tg.initDataUnsafe?.user?.id?.toString();
                const username = tg.initDataUnsafe?.user?.username;
                console.log('User data:', { userId, username });

                // Получаем элементы DOM
                const userNameElement = document.querySelector('.profile-name');
                const adminPanel = document.getElementById('adminPanel');
                const ticketsCountElement = document.getElementById('ticketsCount');
                const lastTicketDateElement = document.getElementById('lastTicketDate');

                // Проверяем наличие всех необходимых элементов
                if (!userNameElement || !adminPanel || !ticketsCountElement || !lastTicketDateElement) {
                    console.error('Some profile elements not found', {
                        userNameElement: !!userNameElement,
                        adminPanel: !!adminPanel,
                        ticketsCountElement: !!ticketsCountElement,
                        lastTicketDateElement: !!lastTicketDateElement
                    });
                    return;
                }

                // Устанавливаем имя пользователя
                userNameElement.textContent = username || 'Пользователь';
                console.log('Username set:', username);

                // Проверяем права администратора
                const isAdmin = userId === "5534462537" || username?.toLowerCase() === "competidora";
                console.log('Is admin:', isAdmin);

                // Показываем/скрываем админ-панель
                adminPanel.style.display = isAdmin ? 'block' : 'none';

                // Загружаем статистику из Firebase
                if (userId) {
                    try {
                        const response = await fetch(`https://city-transport-7bf5d.firebaseio.com/users/${userId}.json`);
                        const userData = await response.json();
                        console.log('Firebase user data:', userData);

                        if (userData) {
                            ticketsCountElement.textContent = userData.ticketsCount || '0';
                            if (userData.lastTicketDate) {
                                const lastTicketDate = new Date(userData.lastTicketDate);
                                lastTicketDateElement.textContent = `${lastTicketDate.toLocaleDateString('ru-RU')} ${lastTicketDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
                            } else {
                                lastTicketDateElement.textContent = '-';
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error);
                        ticketsCountElement.textContent = '0';
                        lastTicketDateElement.textContent = '-';
                    }
                }

                // Если админ, загружаем список пользователей
                if (isAdmin) {
                    await loadUsersList();
                }
            } catch (error) {
                console.error('Error in initializeProfile:', error);
            }
        }
    </script>
</body>

</html>
