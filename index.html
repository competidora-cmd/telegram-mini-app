<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <title>Городской Транспорт</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            -webkit-tap-highlight-color: transparent;

        }



        body {

            background: #fff;

            min-height: 100vh;

            padding: 0;

            margin: 0;

            display: flex;

            flex-direction: column;

        }



        .container {

            max-width: 600px;

            margin: 0 auto;

            width: 100%;

            padding: 20px;

        }



        .tabs {

            display: flex;

            margin-bottom: 20px;

            border-bottom: 1px solid rgba(0, 0, 0, 0.1);

            margin: 0 -16px 20px;

        }



        .tab {

            flex: 1;

            padding: 16px;

            text-align: center;

            color: #8E8E93;

            cursor: pointer;

            position: relative;

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 8px;

            font-size: 15px;

            font-weight: 400;

        }



        .tab svg {

            width: 20px;

            height: 20px;

        }



        .tab.active {

            color: #000;

        }



        .tab.active svg {

            color: #E31E24;

        }



        .tab.active:after {

            content: '';

            position: absolute;

            bottom: -1px;

            left: 16px;

            right: 16px;

            height: 2px;

            background: #E31E24;

        }



        .tab-content {

            display: none;

        }



        .tab-content.active {

            display: block;

        }



        .form-group {

            margin-bottom: 24px;

            position: relative;

        }



        label {

            display: block;

            margin-bottom: 10px;

            font-weight: 400;

            color: #8E8E93;

            font-size: 15px;

        }



        input, select {

            width: 100%;

            padding: 16px;

            border: 1px solid rgba(60, 60, 67, 0.1);

            border-radius: 14px;

            font-size: 17px;

            background: #fff;

            color: #000;

            transition: all 0.2s ease;

            -webkit-appearance: none;

            appearance: none;

        }



        /* Стили для выпадающего списка */
        select {

            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");

            background-repeat: no-repeat;

            background-position: right 16px center;

            padding-right: 40px; /* Место для стрелки */

        }



        input::placeholder {

            color: #8E8E93;

            font-size: 17px;

        }



        input:focus, select:focus {

            outline: none;

            border-color: #007AFF;

            box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.1);

        }



        /* iOS-style Range Input */
        input[type="range"] {

            -webkit-appearance: none;

            background: transparent;

            padding: 0;

            border: none;

            margin: 24px 0;

            height: 44px;

        }



        input[type="range"]::-webkit-slider-runnable-track {

            width: 100%;

            height: 2px;

            background: #E9E9EA;

            border: none;

            border-radius: 1px;

            transition: all 0.2s ease;

        }



        input[type="range"]::-webkit-slider-thumb {

            -webkit-appearance: none;

            border: none;

            height: 28px;

            width: 28px;

            border-radius: 50%;

            background: #fff;

            box-shadow: 0 0 1px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.1);

            margin-top: -13px;

            position: relative;

            z-index: 1;

            cursor: pointer;

            transition: all 0.2s ease;

        }



        #quantity-display {

            text-align: left;

            color: #000;

            font-size: 17px;

            margin-top: 12px;

            font-weight: 400;

        }



        .route-selector {

            display: flex;

            flex-direction: column;

            gap: 12px;

            margin-top: 8px;

        }



        .route-endpoint {

            width: 100%;

            padding: 16px;

            border: 1px solid rgba(60, 60, 67, 0.1);

            border-radius: 14px;

            font-size: 17px;

            background: #fff;

            color: #000;

            transition: all 0.2s ease;

            -webkit-appearance: none;

            appearance: none;

            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");

            background-repeat: no-repeat;

            background-position: right 16px center;

            padding-right: 40px;

        }



        /* Стили для мобильных устройств */
        @media (max-width: 480px) {

            .container {

                padding: 16px;

            }



            .form-group {

                margin-bottom: 20px;

            }



            label {

                font-size: 15px;

                margin-bottom: 8px;

                opacity: 0.8;

            }



            input, select, .route-endpoint {

                padding: 16px;

                font-size: 17px;

            }



            select, .route-endpoint {

                background-position: right 16px center;

                padding-right: 40px;

            }



            /* Увеличиваем область касания для выпадающих списков */
            select:focus, .route-endpoint:focus {

                border-color: #007AFF;

                box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.1);

            }

        }



        /* Остальные стили остаются без изменений */
        .cost-selector {

            display: flex;

            gap: 8px;

            margin-top: 12px;

        }



        .cost-option {

            flex: 1;

            display: flex;

            align-items: center;

            justify-content: center;

            padding: 15px;

            background: #F5F5F5;

            border-radius: 14px;

            cursor: pointer;

            transition: all 0.2s ease;

            border: 1px solid transparent;

        }



        .cost-option:hover {

            background: #F0F0F0;

        }



        .cost-option input {

            display: none;

        }



        .cost-option span {

            font-size: 17px;

            color: #8E8E93;

            transition: all 0.2s ease;

            font-weight: 400;

        }



        .cost-option input:checked + span {

            color: #000;

            font-weight: 500;

        }



        .cost-option:has(input:checked) {

            background: #FFE5E5;

            border-color: rgba(227, 30, 36, 0.1);

        }



        button#createTicketBtn {

            width: 100%;

            padding: 16px;

            background: #E31E24;

            border: none;

            border-radius: 14px;

            color: white;

            font-size: 17px;

            font-weight: 500;

            cursor: pointer;

            margin-top: 32px;

            transition: all 0.2s ease;

        }



        button#createTicketBtn:hover {

            background: #D31E24;

        }



        button#createTicketBtn:active {

            transform: scale(0.98);

        }



        /* Visual feedback for invalid inputs */
        input:invalid {

            border-color: #FF3B30;

        }



        input:invalid:focus {

            border-color: #FF3B30;

            box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.1);

        }



        /* Helper text styles */
        .helper-text {

            font-size: 12px;

            color: #8E8E93;

            margin-top: 4px;

            display: none;

        }



        input:focus + .helper-text {

            display: block;

        }



        /* Error message styles */
        .error-message {

            font-size: 12px;

            color: #FF3B30;

            margin-top: 4px;

            display: none;

        }



        input:invalid + .error-message {

            display: block;

        }



        .saved-tickets {

            display: flex;

                flex-direction: column;

                gap: 12px;

            }



        .ticket-item {

            background: #fff;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 12px;

            padding: 16px;

            }



        .ticket-info {

            display: flex;

            justify-content: space-between;

            align-items: center;

            gap: 12px;

        }



        .ticket-details {

            flex: 1;

        }



        .ticket-number {

            font-size: 20px;

            color: #E31E24;

            margin-bottom: 4px;

            }



        .ticket-route {

            font-size: 15px;

            color: #8E8E93;

        }



        .ticket-actions {

            display: flex;

            gap: 8px;

            flex-wrap: nowrap;

            justify-content: flex-end;

            min-width: 240px;

        }



        .edit-btn, .open-btn, .delete-btn {

            padding: 8px 12px;

            border: none;

            border-radius: 8px;

            font-size: 15px;

            cursor: pointer;

            white-space: nowrap;

            text-align: center;

            width: 80px;

            flex-shrink: 0;

        }



        .edit-btn, .open-btn {

            background: #F7F7F7;

            color: #000;

        }



        .delete-btn {

            background: #FFE5E5;

            color: #E31E24;

        }



        .edit-form {

            display: none;

            margin-top: 12px;

            padding-top: 12px;

            border-top: 1px solid rgba(0, 0, 0, 0.1);

        }



        .edit-form.active {

            display: block;

        }



        .edit-field {

            width: 100%;

            padding: 8px 12px;

            margin-bottom: 8px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 8px;

            font-size: 15px;

        }



        .edit-actions {

            display: flex;

            gap: 8px;

            margin-top: 12px;

        }



        .save-btn, .cancel-btn {

            flex: 1;

            padding: 8px 16px;

            border-radius: 8px;

            border: none;

            font-size: 15px;

            cursor: pointer;

            margin: 0;

        }



        .save-btn {

            background: #E31E24;

            color: white;

        }



        .cancel-btn {

            background: #F7F7F7;

            color: #000;

        }



        @media (max-width: 480px) {

            .ticket-info {

                flex-direction: column;

                align-items: flex-start;

                gap: 12px;

            }



            .ticket-actions {

            width: 100%;

                justify-content: space-between;

                min-width: unset;

        }



            .edit-btn, .open-btn, .delete-btn {

            flex: 1;

                width: auto;

                min-width: 70px;

            }

        }



        @media (max-width: 360px) {

            .ticket-actions {

                flex-wrap: wrap;

                gap: 8px;

            }



            .edit-btn, .open-btn, .delete-btn {

                min-width: calc(50% - 4px);

            }



            .delete-btn {

                width: 100%;

            }

        }



        .reverse-btn {

            padding: 4px;

            background: #F7F7F7;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 8px;

            cursor: pointer;

            display: flex;

            align-items: center;

            justify-content: center;

            width: 32px;

            height: 32px;

            flex-shrink: 0;

            margin: 0 4px;

        }



        .reverse-btn:hover {

            background: #E8E8E8;

        }



        .reverse-btn svg {

            width: 16px;

            height: 16px;

            color: #8E8E93;

        }



        .modal-backdrop {

            display: none;

            position: fixed;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background: rgba(0, 0, 0, 0.5);

            z-index: 1000;

            align-items: center;

            justify-content: center;

        }



        .modal {

            background: white;

            border-radius: 14px;

            padding: 20px;

            width: 85%;

            max-width: 320px;

            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);

        }



        .modal-title {

            font-size: 18px;

            font-weight: 500;

            margin-bottom: 16px;

            text-align: center;

        }



        .modal-actions {

            display: flex;

            gap: 12px;

            margin-top: 20px;

        }



        .modal-btn {

            flex: 1;

            padding: 12px;

            border-radius: 10px;

            border: none;

            font-size: 16px;

            cursor: pointer;

            text-align: center;

        }



        .modal-cancel {

            background: #F7F7F7;

            color: #000;

        }



        .modal-confirm {

            background: #E31E24;

            color: white;

        }



        @media (max-width: 480px) {

            .route-selector {

                flex-direction: column;

                gap: 12px;

            }



            .route-endpoint {

                width: 100%;

            }



            .reverse-btn {

                align-self: center;

                transform: rotate(90deg);

            }

        }



        /* Add these new styles */
        .custom-slider {
            position: relative;
            width: 100%;
            height: 60px;
            padding: 15px 0;
        }

        .slider-rail {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #E9E9EA;
            top: 50%;
            transform: translateY(-50%);
        }

        .slider-track {
            position: absolute;
            height: 2px;
            background-color: #E31E24;
            top: 50%;
            transform: translateY(-50%);
        }

        .slider-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
        }

        .slider-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #fff;
            border: 2px solid #E9E9EA;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: border-color 0.2s;
        }

        .slider-dot.active {
            border-color: #E31E24;
        }

        .slider-handle {
            position: absolute;
            width: 28px;
            height: 28px;
            background-color: #fff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 1px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }

        .slider-handle:hover {
            box-shadow: 0 0 2px rgba(0,0,0,0.15), 0 4px 8px rgba(0,0,0,0.15);
        }

        .slider-marks {
            position: absolute;
            width: 100%;
            top: calc(50% + 16px);
        }

        .slider-mark {
            position: absolute;
            transform: translateX(-50%);
            color: #8E8E93;
            font-size: 14px;
        }

        .slider-mark.active {
            color: #000;
        }

        .carrier-selection {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .auto-select-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 16px;
            background: #F7F7F7;
            border: 1px solid rgba(60, 60, 67, 0.1);
            border-radius: 14px;
            color: #000;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .auto-select-btn:hover {
            background: #E8E8E8;
        }

        .auto-select-btn svg {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 480px) {
            .carrier-selection {
                flex-direction: column;
            }
            
            .auto-select-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Styles for verify tab */
        .verify-btn {
            width: 100%;
            padding: 16px;
            background: #E31E24;
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .verify-btn:hover {
            background: #D31E24;
        }

        .verify-btn:active {
            transform: scale(0.98);
        }

        .verify-result {
            margin-top: 24px;
            padding: 16px;
            border-radius: 14px;
            background: #F7F7F7;
            font-size: 15px;
            line-height: 1.4;
        }

        .verify-result.success {
            background: #E8F5E9;
            color: #1B5E20;
        }

        .verify-result.error {
            background: #FFEBEE;
            color: #B71C1C;
        }

        .create-ticket-btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
            display: none;
        }

        .create-ticket-btn:hover {
            background: #43A047;
        }

        .create-ticket-btn:active {
            transform: scale(0.98);
        }

        #verify-content {
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

    </style>

</head>

<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="constructor">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M4 4h16v12H4V4zm8 12v4m-4 0h8M4 8h16M4 12h16"/>
                </svg>
                Конструктор
            </div>
            <div class="tab" data-tab="saved">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                Сохраненные
            </div>
            <div class="tab" data-tab="verify">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Ввести код
            </div>
        </div>

        <div class="tab-content active" id="constructor-content">
            <div class="form-group">
                <label for="routeNumber">Номер маршрута</label>
                <input type="number" id="routeNumber" min="1" max="99" placeholder="Введите номер (1-99)">
            </div>
            <div class="input-group">
                <label for="carrier">Перевозчик</label>
                <div class="carrier-selection">
                <select id="carrier" required>
                    <option value="">Выберите перевозчика</option>
                </select>
                    <button id="autoSelectCarrier" class="auto-select-btn">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z"/>
                        </svg>
                        Автовыбор
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="route">Маршрут</label>
                <div class="route-selector">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <button id="autoSelectRoute" class="auto-select-btn" style="flex: 1;">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z"/>
                            </svg>
                            Автовыбор маршрута
                        </button>
                    </div>
                    <div style="color: #8E8E93; font-size: 13px; margin-bottom: 8px;">
                        * Автовыбор работает только для автобусных маршрутов и не всегда может быть точным
                    </div>
                    <input type="hidden" id="route">
                    <select id="routeStart" class="route-endpoint">
                        <option value="">Начальная остановка</option>
                    </select>
                    <button id="reverseRoute" class="reverse-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M7.5 21.5l1.5-1.5-4.5-4.5H21v-2H4.5l4.5-4.5-1.5-1.5L1 14l6.5 7.5zm9-19l-1.5 1.5 4.5 4.5H3v2h16.5l-4.5 4.5 1.5 1.5L23 10l-6.5-7.5z"/>
                        </svg>
                    </button>
                    <select id="routeEnd" class="route-endpoint">
                        <option value="">Конечная остановка</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="vehicle">Гос. номер</label>
                <input type="text" id="vehicle" placeholder="Например: р471тм124">
            </div>
            <div class="form-group">
                <label for="quantity">Количество билетов</label>
                <div class="custom-slider" id="quantity-slider-container">
                    <div class="slider-rail"></div>
                    <div class="slider-track"></div>
                    <div class="slider-dots">
                        <span class="slider-dot active" style="left: 0%"></span>
                        <span class="slider-dot" style="left: 25%"></span>
                        <span class="slider-dot" style="left: 50%"></span>
                        <span class="slider-dot" style="left: 75%"></span>
                        <span class="slider-dot" style="left: 100%"></span>
                    </div>
                    <div class="slider-handle" style="left: 0%"></div>
                    <div class="slider-marks">
                        <span class="slider-mark active" style="left: 0%">1</span>
                        <span class="slider-mark" style="left: 25%">2</span>
                        <span class="slider-mark" style="left: 50%">3</span>
                        <span class="slider-mark" style="left: 75%">4</span>
                        <span class="slider-mark" style="left: 100%">5</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="cost">Стоимость</label>
                <div class="cost-selector">
                    <label class="cost-option">
                        <input type="radio" name="cost" value="44.00" checked>
                        <span>44.00₽</span>
                    </label>
                    <label class="cost-option">
                        <input type="radio" name="cost" value="40.00">
                        <span>40.00₽</span>
                    </label>
                </div>
            </div>
            <button id="createTicketBtn">Создать билет</button>
        </div>

        <div class="tab-content" id="saved-content">
            <div id="saved-tickets-list" class="saved-tickets"></div>
        </div>

        <div class="tab-content" id="verify-content">
            <div class="form-group">
                <label for="verifyCode">Код с наклейки автобуса</label>
                <input type="text" id="verifyCode" placeholder="Введите 6-значный код" maxlength="6" pattern="\d{6}">
            </div>
            <button id="verifyCodeBtn" class="verify-btn">Проверить код</button>
            <div id="verifyResult" class="verify-result" style="display: none;"></div>
        </div>
    </div>

    <div class="modal-backdrop" id="delete-confirmation">
        <div class="modal">
            <div class="modal-title">Вы уверены, что хотите удалить этот билет?</div>
            <div class="modal-actions">
                <button class="modal-btn modal-cancel">Отмена</button>
                <button class="modal-btn modal-confirm">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
        } catch (error) {
            console.error('Error initializing Telegram Web App:', error);
            // Если не удалось инициализировать, создаем заглушку
            tg = {
                initDataUnsafe: { user: { id: 'test_user' } },
                close: () => console.log('Close called'),
                expand: () => console.log('Expand called'),
                ready: () => console.log('Ready called')
            };
        }

        const userId = tg.initDataUnsafe?.user?.id || 'unknown';
        
        // Add access check function
        async function checkAccess() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/users_data.json');
                const data = await response.json();
                
                const currentUserId = tg.initDataUnsafe?.user?.id?.toString();
                const currentUsername = tg.initDataUnsafe?.user?.username;

                console.log('Current User ID:', currentUserId);
                console.log('Current Username:', currentUsername);
                console.log('Allowed Users:', data.allowed_users);
                console.log('Users List:', data.users);

                // Проверяем доступ по ID
                if (data.allowed_users.includes(currentUserId)) {
                    console.log('Access granted by ID');
                    return true;
                }

                // Проверяем доступ по username
                if (currentUsername) {
                    // Ищем пользователя в списке users по username
                    const foundUser = Object.entries(data.users).find(([_, userInfo]) => 
                        userInfo.username?.toLowerCase() === currentUsername.toLowerCase()
                    );

                    if (foundUser) {
                        const [userId, _] = foundUser;
                        // Если нашли пользователя, проверяем есть ли его ID в allowed_users
                        if (data.allowed_users.includes(userId)) {
                            console.log('Access granted by username');
                            return true;
                        }
                    }
                }

                // Если доступ не найден ни по ID, ни по username
                console.log('Access denied');
                alert('У вас нет доступа к этому приложению');
                tg.close();
                return false;
            } catch (error) {
                console.error('Error checking access:', error);
                alert('Ошибка при проверке доступа');
                tg.close();
                return false;
            }
        }

        // Check access when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const hasAccess = await checkAccess();
            if (!hasAccess) {
                document.getElementById('constructor-content').style.display = 'none';
                document.getElementById('saved-content').style.display = 'none';
                return;
            }
            
            populateCarrierDropdown();
            populateRouteEndpoints();
        });

        // Modify createTicketBtn click handler
        const createTicketBtn = document.getElementById('createTicketBtn');
        createTicketBtn.addEventListener('click', async function() {
            const hasAccess = await checkAccess();
            if (!hasAccess) {
                return;
            }
            
            const routeNumber = document.getElementById('routeNumber').value;
            const carrier = document.getElementById('carrier').value;
            const startValue = document.getElementById('routeStart').value;
            const endValue = document.getElementById('routeEnd').value;
            const route = `${startValue} - ${endValue}`;
            const vehicle = document.getElementById('vehicle').value;
            // Get quantity from slider position
            const sliderHandle = document.querySelector('.slider-handle');
            const handlePosition = parseInt(sliderHandle.style.left);
            const quantity = Math.floor(handlePosition / 25) + 1;
            const baseCost = document.querySelector('input[name="cost"]:checked').value;
            const totalCost = (parseFloat(baseCost) * quantity).toFixed(2);

            if (!routeNumber || !carrier || !startValue || !endValue || !vehicle) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            if (routeNumber < 1 || routeNumber > 99) {
                alert('Номер маршрута должен быть от 1 до 99');
                return;
            }

            const ticketCode = generateRandomTicketNumber();
            
            // Создаем объект билета
            const ticket = {
                routeNumber,
                carrier,
                route,
                vehicle,
                quantity,
                cost: totalCost,
                baseCost: baseCost,
                code: ticketCode,
                date: new Date().toISOString()
            };

            // Получаем текущие сохраненные билеты
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            
            // Добавляем новый билет в начало массива
            savedTickets.unshift(ticket);
            
            // Сохраняем обновленный массив
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

            const params = new URLSearchParams();
            params.append('userId', userId);
            params.append('routeNumber', routeNumber);
            params.append('carrier', carrier);
            params.append('route', route);
            params.append('vehicle', vehicle);
            params.append('quantity', quantity);
            params.append('cost', totalCost);
            params.append('baseCost', baseCost);
            params.append('code', ticketCode);
            
            window.location.href = 'https://competidora-cmd.github.io/telegram-mini-app/ticket.html?' + params.toString();
        });

        // Встроенные данные о маршрутах и перевозчиках
        const routesData = {
            "routes": {
                "3": {
                    "name": "Маршрут 3",
                    "carriers": ["ИП Патрин Н.Н.", "ООО \"СТК\""]
                },
                "99": {
                    "name": "Маршрут 99",
                    "carriers": ["ООО \"СТК\"", "ИП Патрин Н.Н"]
                }
            },
            "allCarriers": [
                "ИП Багаев Д.Б.",
                "ИП Галченкова Е.А.",
                "ООО «Экипаж-ГО»",
                "ИП Долгушина Г.И.",
                "ИП Тагачаков В.Г.",
                "ООО \"Перевозчик\"",
                "ООО \"СКАД\"",
                "КПАТП-7",
                "КПАТП-5",
                "ООО \"Ветеран\"",
                "ИП Ялтонский А.М.",
                "ИП Читашвили Н.С.",
                "ООО \"Вавулин - К\"",
                "ИП Кривоногов И.Г.",
                "ИП Голунцов С.В.",
                "ИП Цугленок М.М.",
                "ООО «КПАТП»",
                "ИП Галченкова О.Г.",
                "ООО \"Практик\"",
                "ООО \"Сибирь-Авто\"",
                "ИП Бронников А.И.",
                "ИП Бронников М.А.",
                "ИП Долгушин Д.Г.",
                "ООО \"Сирена\"",
                "ИП Патрин Н.Н.",
                "ООО \"МаршрутАвто\"",
                "ИП Карасева Н.Н.",
                "ИП Гнетов Ю.Н.",
                "МП Городской Транспорт",
                "АО \"СТК\"",
            ]
        };

        // Заполнение выпадающего списка перевозчиков
        function populateCarrierDropdown() {
            const carriers = routesData.allCarriers;
            const carrierSelect = document.getElementById('carrier');
            
            // Очищаем текущие опции
            carrierSelect.innerHTML = '';
            
            // Добавляем пустую опцию
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Выберите перевозчика';
            carrierSelect.appendChild(emptyOption);
            
            // Добавляем всех перевозчиков
            carriers.forEach(carrier => {
                const option = document.createElement('option');
                option.value = carrier;
                option.textContent = carrier;
                carrierSelect.appendChild(option);
            });
        }

        // Обновление перевозчика на основе выбранного маршрута
        async function updateCarrierBasedOnRoute() {
            const routeNumber = document.getElementById('routeNumber').value;
            const carrierSelect = document.getElementById('carrier');
            
            if (!routeNumber) return;
            
            const data = await fetchRoutesData();
            const route = data.routes[routeNumber];
            
            if (route && route.carriers && route.carriers.length > 0) {
                    carrierSelect.innerHTML = '';
                    
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Выберите перевозчика для маршрута ' + routeNumber;
                    carrierSelect.appendChild(emptyOption);
                    
                    route.carriers.forEach(carrier => {
                        const option = document.createElement('option');
                        option.value = carrier;
                        option.textContent = carrier;
                        carrierSelect.appendChild(option);
                    });
                
                // If there's only one carrier, select it automatically
                if (route.carriers.length === 1) {
                    carrierSelect.value = route.carriers[0];
                }
            } else {
                populateCarrierDropdown();
            }
        }

        // Заполняем выпадающий список при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            populateCarrierDropdown();
            document.getElementById('routeNumber').addEventListener('change', updateCarrierBasedOnRoute);
        });

        // Функция генерации случайного номера билета
        function generateRandomTicketNumber() {
            // Генерируем случайное число от 972000000 до 974999999
            const prefixes = [972, 973, 974];
            const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const min = randomPrefix * 1000000;
            const max = min + 999999;
            const num = Math.floor(Math.random() * (max - min + 1) + min).toString();
            // Форматируем в виде XXX XXX XXX
            return num.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }

        // Форматирование даты
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year} г.`;
        }

        // Форматирование времени
        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        // Загрузка сохраненных билетов
        function loadSavedTickets() {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const container = document.getElementById('saved-tickets-list');
            container.innerHTML = '';

            savedTickets.forEach((ticket, index) => {
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-item';
                ticketElement.innerHTML = `
                    <div class="ticket-info">
                        <div class="ticket-details">
                            <div class="ticket-number">${ticket.code}</div>
                            <div class="ticket-route">${ticket.routeNumber} ${ticket.route}</div>
                        </div>
                        <div class="ticket-actions">
                            <button class="edit-btn" onclick="toggleEditForm(${index})">Изменить</button>
                            <button class="open-btn" onclick="openSavedTicket(${index})">Открыть</button>
                            <button class="delete-btn" onclick="confirmDeleteTicket(${index})">Удалить</button>
                        </div>
                    </div>
                    <div class="edit-form" id="edit-form-${index}">
                        <input type="number" class="edit-field" id="edit-routeNumber-${index}" 
                               value="${ticket.routeNumber}" 
                               min="1" max="99"
                               placeholder="Номер маршрута (1-99)">
                        <input type="text" class="edit-field" id="edit-carrier-${index}" 
                               value="${ticket.carrier}" 
                               placeholder="Например: ИП Патрин Н. Н.">
                        <input type="text" class="edit-field" id="edit-route-${index}" 
                               value="${ticket.route}" 
                               placeholder="Например: Красфарма (60 лет Октября) - Х/К Енисей">
                        <input type="text" class="edit-field" id="edit-vehicle-${index}" 
                               value="${ticket.vehicle}" 
                               placeholder="Например: р471тм124">
                        <input type="range" class="edit-field" id="edit-quantity-slider-${index}" min="1" max="5" value="${ticket.quantity}" step="1" oninput="updateEditQuantityDisplay(${index}, this.value)">
                        <div id="edit-quantity-display-${index}">${ticket.quantity} ${ticket.quantity === '1' ? 'билет' : 'билета'}</div>
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveEditedTicket(${index})">Сохранить</button>
                            <button class="cancel-btn" onclick="toggleEditForm(${index})">Отмена</button>
                        </div>
                    </div>
                `;
                container.appendChild(ticketElement);

                // Add keyboard handling for edit form inputs
                const editFormInputs = document.querySelectorAll(`#edit-form-${index} input[type="text"], #edit-form-${index} input[type="number"]`);
                editFormInputs.forEach(input => {
                    // Handle enter key
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur(); // Remove focus and hide keyboard
                        }
                    });
                });
            });

            // Add click handler to dismiss keyboard when clicking outside inputs
            document.addEventListener('click', function(e) {
                const activeElement = document.activeElement;
                if (activeElement && 
                    !e.target.matches('input[type="text"], input[type="number"]') && // Don't blur if clicking on inputs
                    !e.target.matches('select, select *') && // Don't blur if clicking on select elements
                    (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
                    activeElement.blur();
                }
            });
        }

        // Открытие сохраненного билета
        function openSavedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];
            const params = new URLSearchParams();
            
            // Generate a new ticket number
            const newTicketCode = generateRandomTicketNumber();
            
            // Get the base cost per ticket and quantity
            const quantity = parseInt(ticket.quantity || 1);
            let baseCost;
            
            if (ticket.baseCost) {
                baseCost = parseFloat(ticket.baseCost);
            } else {
                // For backwards compatibility with older tickets
                baseCost = parseFloat(ticket.cost) / quantity;
            }
            
            const totalCost = (baseCost * quantity).toFixed(2);
            
            // Add parameters
            params.append('userId', userId);
            params.append('routeNumber', ticket.routeNumber);
            params.append('carrier', ticket.carrier);
            params.append('route', ticket.route);
            params.append('vehicle', ticket.vehicle);
            params.append('quantity', quantity);
            params.append('cost', totalCost);
            params.append('baseCost', baseCost.toFixed(2));
            params.append('code', newTicketCode); // Use the new ticket code
            
            if (ticket.date) {
                params.append('date', ticket.date);
            }

            // Update the ticket code in localStorage
            ticket.code = newTicketCode;
            savedTickets[index] = ticket;
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

            window.location.href = 'ticket.html?' + params.toString();
        }

        // Переключение формы редактирования
        function toggleEditForm(index) {
            const form = document.getElementById(`edit-form-${index}`);
            form.classList.toggle('active');
        }

        // Сохранение отредактированного билета
        function saveEditedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];

            const routeNumber = document.getElementById(`edit-routeNumber-${index}`).value;
            if (routeNumber < 1 || routeNumber > 99) {
                alert('Номер маршрута должен быть от 1 до 99');
                return;
            }

            const newCarrier = document.getElementById(`edit-carrier-${index}`).value;
            const newQuantity = parseInt(document.getElementById(`edit-quantity-slider-${index}`).value);
            
            // Update ticket data
            ticket.routeNumber = routeNumber;
            ticket.carrier = newCarrier;
            ticket.route = document.getElementById(`edit-route-${index}`).value;
            ticket.vehicle = document.getElementById(`edit-vehicle-${index}`).value;
            ticket.quantity = newQuantity;
            
            // Calculate the base cost per ticket properly
            let baseCost;
            if (ticket.baseCost) {
                // Use the stored base cost if available
                baseCost = parseFloat(ticket.baseCost);
            } else {
                // If not available (for older tickets), use one of the standard costs
                baseCost = 44.00; // Default to 44.00 if not specified
            }
            
            // Calculate new total cost based on the new quantity
            const totalCost = (baseCost * newQuantity).toFixed(2);
            ticket.cost = totalCost;

            savedTickets[index] = ticket;
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
            loadSavedTickets();
            toggleEditForm(index);
        }

        // Переключение вкладок
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-content').classList.add('active');
                
                if (tab.dataset.tab === 'saved') {
                    loadSavedTickets();
                }
            });
        });

        // Загрузка сохраненных билетов при старте
        if (document.querySelector('.tab[data-tab="saved"]').classList.contains('active')) {
            loadSavedTickets();
        }

        // Add route endpoints data
        const routeEndpoints = [
            "ЛДК",
            "ТЭЦ-3",
            'ОАО "Русал"',
            "мкрн. Верхние черёмушки",
            "Академия биатлона",
            "мкрн. Тихие Зори",
            "Ст. Красноярск-Северный",
            "Стела",
            "мкрн. Солнечный",
            "Спортзал",
            "Озеро-парк",
            "Красфарма (60 лет Октября)",
            "Контейнерный двор",
            "Химкомбинат Енисей",
            "пос. Зыково",
            "пос. Таймыр",
            "Ж/Д Вокзал",
            "Причал",
            "А/В Восточный",
            "Дом учёных",
            "Верхняя базаиха",
            "С/О Южное",
            "Сельхозкомплекс",
            "ДК Кировский",
            "Агротерминал",
            "Междугородный вокзал",
            'Спорткомплекс "Радуга"',
            "ОАО Красфарма",
            "Парашютная",
            "Госпиталь ВОВ",
            "пос. Энергетиков",
            "Северный",
            "Цимлянская",
            "Планета (ул. 9 Мая)",
            "Фанпарк Бобровый лог",
            "с/х Удачный",
            "ж/к Ясный",
            "ИТК",
            "мкрн.Солнечный (ул. Светлова)",
            "Ж/Д больница",
            "Шинное кладбище",
            "Профилакторий з-да КраМЗ",
            "Парк Прищепка",
            "пос. Овинный",
            "Плодово-ягодная станция"
        ];

        // Populate route endpoints dropdowns
        function populateRouteEndpoints() {
            const startSelect = document.getElementById('routeStart');
            const endSelect = document.getElementById('routeEnd');
            
            // Clear existing options first
            startSelect.innerHTML = '<option value="">Начальная остановка</option>';
            endSelect.innerHTML = '<option value="">Конечная остановка</option>';
            
            // Add endpoints once to each dropdown
            routeEndpoints.forEach(endpoint => {
                const startOption = document.createElement('option');
                const endOption = document.createElement('option');
                
                startOption.value = endpoint;
                startOption.textContent = endpoint;
                endOption.value = endpoint;
                endOption.textContent = endpoint;
                
                startSelect.appendChild(startOption);
                endSelect.appendChild(endOption);
            });
        }

        // Handle route reverse
        document.getElementById('reverseRoute').addEventListener('click', function() {
            const startSelect = document.getElementById('routeStart');
            const endSelect = document.getElementById('routeEnd');
            
            const tempValue = startSelect.value;
            startSelect.value = endSelect.value;
            endSelect.value = tempValue;
            
            updateRouteDisplay();
        });

        // Update route display when endpoints change
        function updateRouteDisplay() {
            const startValue = document.getElementById('routeStart').value;
            const endValue = document.getElementById('routeEnd').value;
            
            if (startValue && endValue) {
                document.getElementById('route').value = `${startValue} - ${endValue}`;
            }
        }

        // Add event listeners for endpoint changes
        document.getElementById('routeStart').addEventListener('change', updateRouteDisplay);
        document.getElementById('routeEnd').addEventListener('change', updateRouteDisplay);

        // Initialize route endpoints on page load
        document.addEventListener('DOMContentLoaded', function() {
            populateRouteEndpoints();
            // ... existing DOMContentLoaded code ...
        });

        // Add delete ticket functionality
        function confirmDeleteTicket(index) {
            const modalBackdrop = document.getElementById('delete-confirmation');
            const modal = document.querySelector('.modal');
            const deleteBtn = document.querySelector('.delete-btn');
            const cancelBtn = document.querySelector('.modal-cancel');
            const confirmBtn = document.querySelector('.modal-confirm');

            // Show the modal
            modalBackdrop.style.display = 'flex';
            modal.style.display = 'block';

            // Add event listeners for modal actions
            cancelBtn.addEventListener('click', function() {
                modalBackdrop.style.display = 'none';
                modal.style.display = 'none';
            });

            confirmBtn.addEventListener('click', function() {
                const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
                savedTickets.splice(index, 1);
                localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
                loadSavedTickets();
                modalBackdrop.style.display = 'none';
                modal.style.display = 'none';
            });
        }

        // Function to update quantity display in edit form
        function updateEditQuantityDisplay(index, value) {
            document.getElementById(`edit-quantity-display-${index}`).textContent = `${value} ${value === '1' ? 'билет' : 'билета'}`;
        }

        // Update the createTicketBtn click handler
        const quantitySlider = document.getElementById('quantity-slider-container');
        quantitySlider.addEventListener('click', function(event) {
            const rect = quantitySlider.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = (x / rect.width) * 100;
            updateSlider(percentage);
        });

        // Add keyboard handling for input fields
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard handling for text and number inputs only
            const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
                    inputs.forEach(input => {
                        // Handle enter key
                        input.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                input.blur(); // Remove focus from input
                            }
                });
            });

            // Handle clicks outside of inputs, but not on select elements
            document.addEventListener('click', function(e) {
                const activeElement = document.activeElement;
                if (activeElement && 
                    !e.target.matches('select, select *') && // Don't blur if clicking on select elements
                    !e.target.matches('input[type="text"], input[type="number"]') && // Don't blur if clicking on inputs
                    (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
                    activeElement.blur();
                }
            });
            
            // ... rest of your existing DOMContentLoaded code ...
        });

        // Also ensure select elements have proper styling
        const selectElements = document.querySelectorAll('select');
        selectElements.forEach(select => {
            select.style.webkitAppearance = 'none';
            select.style.appearance = 'none';
            select.style.backgroundImage = `url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238E8E93' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            select.style.backgroundRepeat = 'no-repeat';
            select.style.backgroundPosition = 'right 16px center';
            select.style.paddingRight = '40px';
        });

        // Add this new JavaScript code
        document.addEventListener('DOMContentLoaded', function() {
            const sliderContainer = document.getElementById('quantity-slider-container');
            const handle = sliderContainer.querySelector('.slider-handle');
            const track = sliderContainer.querySelector('.slider-track');
            const quantityInput = document.getElementById('quantity-input');
            const quantityDisplay = document.getElementById('quantity-display');
            const dots = sliderContainer.querySelectorAll('.slider-dot');
            const marks = sliderContainer.querySelectorAll('.slider-mark');
            let isDragging = false;

            function updateSlider(percentage) {
                // Snap to nearest step (0%, 25%, 50%, 75%, 100%)
                const steps = [0, 25, 50, 75, 100];
                const closestStep = steps.reduce((prev, curr) => 
                    Math.abs(curr - percentage) < Math.abs(prev - percentage) ? curr : prev
                );

                // Update handle and track position
                handle.style.left = `${closestStep}%`;
                track.style.width = `${closestStep}%`;

                // Update quantity value (1-5)
                const quantity = (closestStep / 25) + 1;
                quantityInput.value = quantity;
                quantityDisplay.textContent = `${quantity} ${quantity === 1 ? 'билет' : 'билета'}`;

                // Update active states
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index * 25 <= closestStep);
                });
                marks.forEach((mark, index) => {
                    mark.classList.toggle('active', index * 25 <= closestStep);
                });
            }

            function handleMove(event) {
                if (!isDragging) return;
                
                const rect = sliderContainer.getBoundingClientRect();
                const x = event.type.includes('touch') ? 
                    event.touches[0].clientX - rect.left :
                    event.clientX - rect.left;
                
                let percentage = (x / rect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                
                updateSlider(percentage);
            }

            function handleStart(event) {
                isDragging = true;
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('touchmove', handleMove);
                document.addEventListener('mouseup', handleEnd);
                document.addEventListener('touchend', handleEnd);
            }

            function handleEnd() {
                isDragging = false;
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('touchmove', handleMove);
                document.removeEventListener('mouseup', handleEnd);
                document.removeEventListener('touchend', handleEnd);
            }

            // Click on container to jump to position
            sliderContainer.addEventListener('click', function(event) {
                const rect = sliderContainer.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const percentage = (x / rect.width) * 100;
                updateSlider(percentage);
            });

            // Drag handling
            handle.addEventListener('mousedown', handleStart);
            handle.addEventListener('touchstart', handleStart);

            // Initialize slider
            updateSlider(0);
        });

        // Add this after the routesData declaration
        async function fetchRoutesData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/routes.json');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching routes data:', error);
                return routesData; // Fallback to local data if fetch fails
            }
        }

        // Add auto-select carrier button functionality
        document.getElementById('autoSelectCarrier').addEventListener('click', async function() {
            const routeNumber = document.getElementById('routeNumber').value;
            if (!routeNumber) {
                alert('Сначала выберите номер маршрута');
                return;
            }
            
            const data = await fetchRoutesData();
            const route = data.routes[routeNumber];
            
            if (route && route.carriers && route.carriers.length > 0) {
                const carrierSelect = document.getElementById('carrier');
                if (route.carriers.length === 1) {
                    carrierSelect.value = route.carriers[0];
                } else {
                    // If multiple carriers, show them in the dropdown
                    updateCarrierBasedOnRoute();
                }
            } else {
                alert('Для этого маршрута нет доступных перевозчиков');
            }
        });

        // Remove duplicate button creation code and update the auto-select route function
        async function autoSelectRoute() {
            const routeNumber = document.getElementById('routeNumber').value;
            
            if (!routeNumber) {
                alert('Пожалуйста, сначала выберите номер маршрута');
                return;
            }

            try {
                const response = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/route.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                if (data.routes[routeNumber]) {
                    const route = data.routes[routeNumber];
                    const startSelect = document.getElementById('routeStart');
                    const endSelect = document.getElementById('routeEnd');
                    
                    // Ensure options exist for the route stops
                    function ensureOption(select, value) {
                        let option = Array.from(select.options).find(opt => opt.value === value);
                        if (!option) {
                            option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            select.appendChild(option);
                        }
                        return option;
                    }
                    
                    // Add and select the options from route.json
                    if (route.start) {
                        ensureOption(startSelect, route.start);
                        startSelect.value = route.start;
                    }
                    
                    if (route.end) {
                        ensureOption(endSelect, route.end);
                        endSelect.value = route.end;
                    }
                    
                    // Update the route display
                    document.getElementById('route').value = `${route.start} - ${route.end}`;
                } else {
                    alert('Маршрут не найден');
                }
            } catch (error) {
                console.error('Error fetching route data:', error);
                alert('Ошибка при получении данных о маршруте');
            }
        }

        // Remove duplicate event listener code and add it to DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing DOMContentLoaded code ...
            
            // Add event listener for auto-select route button
            const autoSelectRouteBtn = document.getElementById('autoSelectRoute');
            if (autoSelectRouteBtn) {
                autoSelectRouteBtn.addEventListener('click', autoSelectRoute);
            }
        });

        // Add code verification functionality
        document.getElementById('verifyCodeBtn').addEventListener('click', async function() {
            const code = document.getElementById('verifyCode').value.trim();
            const resultDiv = document.getElementById('verifyResult');
            
            // Проверка формата кода
            if (!code || !/^\d{6}$/.test(code)) {
                resultDiv.className = 'verify-result error';
                resultDiv.textContent = 'Пожалуйста, введите 6-значный код';
                resultDiv.style.display = 'block';
                return;
            }

            try {
                // Шаг 1: Проверяем код в base_code.json
                const baseCodeResponse = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/base_code.json');
                if (!baseCodeResponse.ok) {
                    throw new Error('Ошибка при загрузке базы кодов');
                }
                const baseCodeData = await baseCodeResponse.json();
                
                // Ищем код в базе
                const codeEntry = baseCodeData.codes.find(entry => entry.code === code);
                if (!codeEntry) {
                    resultDiv.className = 'verify-result error';
                    resultDiv.textContent = 'Код не найден в базе данных';
                    resultDiv.style.display = 'block';
                    return;
                }

                const routeNumber = codeEntry.route;

                // Шаг 2: Получаем информацию о маршруте из route.json
                const routeResponse = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/route.json');
                if (!routeResponse.ok) {
                    throw new Error('Ошибка при загрузке информации о маршруте');
                }
                const routeData = await routeResponse.json();
                
                const routeInfo = routeData.routes[routeNumber];
                if (!routeInfo) {
                    throw new Error('Информация о маршруте не найдена');
                }

                // Шаг 3: Получаем информацию о перевозчиках из routes.json
                const routesResponse = await fetch('https://raw.githubusercontent.com/competidora-cmd/telegram-mini-app/main/routes.json');
                if (!routesResponse.ok) {
                    throw new Error('Ошибка при загрузке информации о перевозчиках');
                }
                const routesData = await routesResponse.json();
                
                const routeCarriers = routesData.routes[routeNumber]?.carriers || [];
                const carrier = routeCarriers[0] || 'Перевозчик не указан';

                // Отображаем результаты
                resultDiv.className = 'verify-result success';
                resultDiv.innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>Результат проверки:</strong></div>
                    <div><strong>Маршрут:</strong> ${routeNumber}</div>
                    <div><strong>Начальная остановка:</strong> ${routeInfo.start}</div>
                    <div><strong>Конечная остановка:</strong> ${routeInfo.end}</div>
                    <div><strong>Перевозчик:</strong> ${carrier}</div>
                    <button id="createVerifiedTicket" class="create-ticket-btn" style="display: block; margin-top: 16px;">Создать билет</button>
                `;
                resultDiv.style.display = 'block';

                // Добавляем обработчик для создания билета
                document.getElementById('createVerifiedTicket').addEventListener('click', function() {
                    const ticketData = {
                        routeNumber: routeNumber,
                        carrier: carrier,
                        route: `${routeInfo.start} - ${routeInfo.end}`,
                        vehicle: code,
                        quantity: 1,
                        cost: "44.00",
                        baseCost: "44.00",
                        code: generateRandomTicketNumber(),
                        date: new Date().toISOString()
                    };

                    // Сохраняем билет и перенаправляем
                    const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
                    savedTickets.unshift(ticketData);
                    localStorage.setItem('savedTickets', JSON.stringify(savedTickets));

                    const params = new URLSearchParams();
                    Object.entries(ticketData).forEach(([key, value]) => {
                        params.append(key, value);
                    });
                    params.append('userId', userId);

                    window.location.href = 'ticket.html?' + params.toString();
                });

            } catch (error) {
                console.error('Error verifying code:', error);
                resultDiv.className = 'verify-result error';
                resultDiv.textContent = 'Произошла ошибка: ' + error.message;
                resultDiv.style.display = 'block';
            }
        });

        // Добавляем валидацию ввода для поля с кодом
        document.getElementById('verifyCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '').slice(0, 6);
        });
    </script>
</body>

</html>
