<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <title>Городской Транспорт</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            -webkit-tap-highlight-color: transparent;

        }



        body {

            background: #fff;

            min-height: 100vh;

            padding: 0;

            margin: 0;

            display: flex;

            flex-direction: column;

        }



        .container {

            max-width: 600px;

            margin: 0 auto;

            width: 100%;

            padding: 16px;

        }



        .tabs {

            display: flex;

            margin-bottom: 20px;

            border-bottom: 1px solid rgba(0, 0, 0, 0.1);

            margin: 0 -16px 20px;

        }



        .tab {

            flex: 1;

            padding: 16px;

            text-align: center;

            color: #8E8E93;

            cursor: pointer;

            position: relative;

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 8px;

            font-size: 15px;

            font-weight: 400;

        }



        .tab svg {

            width: 20px;

            height: 20px;

        }



        .tab.active {

            color: #000;

        }



        .tab.active svg {

            color: #E31E24;

        }



        .tab.active:after {

            content: '';

            position: absolute;

            bottom: -1px;

            left: 16px;

            right: 16px;

            height: 2px;

            background: #E31E24;

        }



        .tab-content {

            display: none;

        }



        .tab-content.active {

            display: block;

        }



        .form-group {

            margin-bottom: 20px;

        }



        label {

            display: block;

            margin-bottom: 8px;

            font-weight: 400;

            color: #8E8E93;

            font-size: 15px;

        }



        input, select {

            width: 100%;

            padding: 12px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 10px;

            font-size: 17px;

            background: #fff;

            color: #000;

        }



        input:focus, select:focus {

            outline: none;

            border-color: #E31E24;

        }



        input::placeholder {

            color: #8E8E93;

        }



        button {

            width: 100%;

            padding: 16px;

            background: #E31E24;

            border: none;

            border-radius: 14px;

            color: white;

            font-size: 17px;

            font-weight: 500;

            cursor: pointer;

            margin-top: 24px;

        }



        .error {

            color: #E31E24;

            font-size: 13px;

            margin-top: 4px;

            display: none;

        }



        .saved-tickets {

            display: flex;

            flex-direction: column;

            gap: 12px;

        }



        .ticket-item {

            background: #fff;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 12px;

            padding: 16px;

        }



        .ticket-info {

            display: flex;

            justify-content: space-between;

            align-items: center;

            gap: 12px;

        }



        .ticket-details {

            flex: 1;

        }



        .ticket-number {

            font-size: 20px;

            color: #E31E24;

            margin-bottom: 4px;

        }



        .ticket-route {

            font-size: 15px;

            color: #8E8E93;

        }



        .ticket-actions {

            display: flex;

            gap: 8px;

        }



        .edit-btn, .open-btn {

            padding: 8px 16px;

            background: #F7F7F7;

            border: none;

            border-radius: 8px;

            color: #000;

            font-size: 15px;

            cursor: pointer;

            white-space: nowrap;

            width: auto;

            margin: 0;

        }



        .edit-form {

            display: none;

            margin-top: 12px;

            padding-top: 12px;

            border-top: 1px solid rgba(0, 0, 0, 0.1);

        }



        .edit-form.active {

            display: block;

        }



        .edit-field {

            width: 100%;

            padding: 8px 12px;

            margin-bottom: 8px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 8px;

            font-size: 15px;

        }



        .edit-actions {

            display: flex;

            gap: 8px;

            margin-top: 12px;

        }



        .save-btn, .cancel-btn {

            flex: 1;

            padding: 8px 16px;

            border-radius: 8px;

            border: none;

            font-size: 15px;

            cursor: pointer;

            margin: 0;

        }



        .save-btn {

            background: #E31E24;

            color: white;

        }



        .cancel-btn {

            background: #F7F7F7;

            color: #000;

        }



        @media (max-width: 380px) {

            .ticket-info {

                flex-direction: column;

                align-items: flex-start;

            }



            .ticket-actions {

                width: 100%;

            }



            .edit-btn, .open-btn {

                flex: 1;

                text-align: center;

            }

        }



        .cost-selector {

            display: flex;

            gap: 12px;

            margin-top: 8px;

        }



        .cost-option {

            flex: 1;

            display: flex;

            align-items: center;

            justify-content: center;

            padding: 12px;

            background: #F7F7F7;

            border-radius: 10px;

            cursor: pointer;

            transition: all 0.2s;

        }



        .cost-option input {

            display: none;

        }



        .cost-option span {

            font-size: 17px;

            color: #8E8E93;

            transition: all 0.2s;

        }



        .cost-option input:checked + span {

            color: #000;

            font-weight: 500;

        }



        .cost-option:has(input:checked) {

            background: rgba(227, 30, 36, 0.1);

        }



        .edit-field {

            width: 100%;

            padding: 12px;

            margin-bottom: 12px;

            border: 1px solid rgba(0, 0, 0, 0.1);

            border-radius: 10px;

            font-size: 15px;

            background: #fff;

        }



        .edit-field::placeholder {

            color: #8E8E93;

        }



        .edit-field:focus {

            outline: none;

            border-color: #E31E24;

        }

    </style>

</head>

<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="constructor">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M4 4h16v12H4V4zm8 12v4m-4 0h8M4 8h16M4 12h16"/>
                </svg>
                Конструктор
            </div>
            <div class="tab" data-tab="saved">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                Сохраненные
            </div>
        </div>

        <div class="tab-content active" id="constructor-content">
            <div class="form-group">
                <label for="carrier">Перевозчик</label>
                <input type="text" id="carrier" placeholder="Например: ИП Патрин Н. Н.">
            </div>
            <div class="form-group">
                <label for="route">Маршрут</label>
                <input type="text" id="route" placeholder="Например: Красфарма (60 лет Октября) - Х/К Енисей">
            </div>
            <div class="form-group">
                <label for="vehicle">Гос. номер</label>
                <input type="text" id="vehicle" placeholder="Например: р471тм124">
            </div>
            <div class="form-group">
                <label for="cost">Стоимость</label>
                <div class="cost-selector">
                    <label class="cost-option">
                        <input type="radio" name="cost" value="44.00" checked>
                        <span>44.00₽</span>
                    </label>
                    <label class="cost-option">
                        <input type="radio" name="cost" value="40.00">
                        <span>40.00₽</span>
                    </label>
                </div>
            </div>
            <button onclick="generateTicket()">Создать билет</button>
        </div>

        <div class="tab-content" id="saved-content">
            <div id="saved-tickets-list" class="saved-tickets"></div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // Переключение вкладок
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');

                if (tab.dataset.tab === 'saved') {
                    loadSavedTickets();
                }
            });
        });

        function generateRandomTicketNumber() {
            const num = Math.floor(100000000 + Math.random() * 900000000).toString();
            return `${num.slice(0, 3)} ${num.slice(3, 6)} ${num.slice(6)}`;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = date.toLocaleString('ru', { month: 'long' });
            const year = date.getFullYear();
            return `${day} ${month} ${year} г.`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
        }

        function validateForm() {
            const routeNumber = document.getElementById('routeNumber').value;
            const routePath = document.getElementById('routePath').value;
            const carrier = document.getElementById('carrier').value;
            const vehicleNumber = document.getElementById('vehicleNumber').value;

            let isValid = true;
            document.querySelectorAll('.error').forEach(error => error.style.display = 'none');

            if (!routeNumber || routeNumber < 1 || routeNumber > 99) {
                document.getElementById('routeNumberError').style.display = 'block';
                isValid = false;
            }
            if (!routePath.trim()) {
                document.getElementById('routePathError').style.display = 'block';
                isValid = false;
            }
            if (!carrier.trim()) {
                document.getElementById('carrierError').style.display = 'block';
                isValid = false;
            }
            if (!vehicleNumber.trim()) {
                document.getElementById('vehicleNumberError').style.display = 'block';
                isValid = false;
            }

            return isValid;
        }

        function saveTicket(ticketData) {
            let savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            savedTickets.push(ticketData);
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
        }

        function loadSavedTickets() {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const container = document.getElementById('saved-tickets-list');
            container.innerHTML = '';

            savedTickets.forEach((ticket, index) => {
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-item';
                ticketElement.innerHTML = `
                    <div class="ticket-info">
                        <div class="ticket-details">
                            <div class="ticket-number">${ticket.code}</div>
                            <div class="ticket-route">${ticket.route}</div>
                        </div>
                        <div class="ticket-actions">
                            <button class="edit-btn" onclick="toggleEditForm(${index})">Изменить</button>
                            <button class="open-btn" onclick="openTicket(${JSON.stringify(ticket)})">Открыть</button>
                        </div>
                    </div>
                    <div class="edit-form" id="edit-form-${index}">
                        <input type="text" class="edit-field" id="edit-carrier-${index}" 
                               value="${ticket.carrier}" 
                               placeholder="Например: ИП Патрин Н. Н.">
                        <input type="text" class="edit-field" id="edit-route-${index}" 
                               value="${ticket.route}" 
                               placeholder="Например: Красфарма (60 лет Октября) - Х/К Енисей">
                        <input type="text" class="edit-field" id="edit-vehicle-${index}" 
                               value="${ticket.vehicle}" 
                               placeholder="Например: р471тм124">
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveEditedTicket(${index})">Сохранить</button>
                            <button class="cancel-btn" onclick="toggleEditForm(${index})">Отмена</button>
                        </div>
                    </div>
                `;
                container.appendChild(ticketElement);
            });
        }

        function toggleEditForm(index) {
            const form = document.getElementById(`edit-form-${index}`);
            form.classList.toggle('active');
        }

        function saveEditedTicket(index) {
            const savedTickets = JSON.parse(localStorage.getItem('savedTickets') || '[]');
            const ticket = savedTickets[index];

            ticket.carrier = document.getElementById(`edit-carrier-${index}`).value;
            ticket.route = document.getElementById(`edit-route-${index}`).value;
            ticket.vehicle = document.getElementById(`edit-vehicle-${index}`).value;

            savedTickets[index] = ticket;
            localStorage.setItem('savedTickets', JSON.stringify(savedTickets));
            loadSavedTickets();
        }

        function generateTicket() {
            if (!validateForm()) {
                return;
            }

            const now = new Date();
            const routeNumber = document.getElementById('routeNumber').value;
            const routePath = document.getElementById('routePath').value;
            const carrier = document.getElementById('carrier').value;
            const vehicleNumber = document.getElementById('vehicleNumber').value;
            const cost = document.querySelector('input[name="cost"]:checked').value;

            const ticketData = {
                code: generateRandomTicketNumber(),
                carrier: carrier,
                route: `${routeNumber} ${routePath}`,
                vehicle: vehicleNumber,
                cost: cost,
                purchase_date: formatDate(now),
                purchase_time: formatTime(now)
            };

            saveTicket(ticketData);
            openTicket(ticketData);
        }

        function openTicket(ticketData) {
            const ticketUrl = `ticket.html?` +
                `code=${encodeURIComponent(ticketData.code)}&` +
                `carrier=${encodeURIComponent(ticketData.carrier)}&` +
                `route=${encodeURIComponent(ticketData.route)}&` +
                `vehicle=${encodeURIComponent(ticketData.vehicle)}&` +
                `cost=${encodeURIComponent(ticketData.cost)}&` +
                `purchase_date=${encodeURIComponent(ticketData.purchase_date)}&` +
                `purchase_time=${encodeURIComponent(ticketData.purchase_time)}`;

            window.location.href = ticketUrl;
        }
    </script>
</body>

</html>

