<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Городской Транспорт</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            -webkit-tap-highlight-color: transparent;

            -webkit-touch-callout: none;

            -webkit-user-select: none;

            user-select: none;

        }



        html, body {

            overflow: hidden;

            position: fixed;

            width: 100%;

            height: 100%;

            background-color: white;

            -webkit-text-size-adjust: none;

        }



        body {

            display: flex;

            flex-direction: column;

            min-height: 100vh;

        }



        .container {

            width: 100%;

            padding: 0;

            background-color: white;

            display: flex;

            flex-direction: column;

            flex: 1;

            overflow-y: auto;

            padding-bottom: calc(80px + env(safe-area-inset-bottom));

        }



        .timer {

            text-align: center;

            font-size: 32px;

            font-weight: 400;

            margin: 20px 0;

            color: #000000;

        }



        .tabs {

            display: flex;

            border-bottom: 1px solid #E0E0E0;

            margin-bottom: 15px;

            padding: 0 16px;

            justify-content: center;

        }



        .tab {

            padding: 16px 0;

            margin-right: 32px;

            text-align: center;

            cursor: pointer;

            color: #000000;

            position: relative;

            font-size: 18px;

            display: flex;

            align-items: center;

        }



        .tab:last-child {

            margin-right: 0;

        }



        .tab.active {

            color: #000;

        }



        .tab.active[data-tab="ticket"] .tab-icon {

            color: #E31E24;

        }



        .tab span {

            font-size: 18px;

            font-weight: 500;

        }



        .tab.active:after {

            content: '';

            position: absolute;

            bottom: -1px;

            left: 0;

            right: 0;

            height: 2px;

            background-color: #E31E24;

        }



        .tab-content {

            display: none;

            padding: 0 16px;

        }



        .tab-content.active {

            display: block;

        }



        .ticket-number {

            display: flex;

            align-items: center;

            gap: 12px;

            margin-bottom: 0;

            padding: 20px 16px;

            border-bottom: 1px solid #E0E0E0;

        }



        .ticket-number-icon {

            color: #E31E24;

        }



        .ticket-number-value {

            color: #E31E24;

            font-size: 20px;

            font-weight: 500;

        }



        .info-row {

            display: flex;

            align-items: center;

            gap: 12px;

            margin: 0;

            padding: 20px 16px;

            border-bottom: 1px solid #E0E0E0;

        }



        .info-row:last-child {

            border-bottom: none;

        }



        .info-row svg {

            width: 24px;

            height: 24px;

            color: #000;

            flex-shrink: 0;

        }



        .info-content {

            flex: 1;

        }



        .info-label {

            font-size: 17px;

            color: #8E8E93;

            margin-bottom: 4px;

        }



        .info-value {

            font-size: 20px;

            color: #000;

            font-weight: 400;

        }



        .control-info {

            text-align: center;

            margin: 20px 0;

            color: #000000;

            font-size: 16px;

        }



        #qr-code {

            width: 80%;

            max-width: 300px;

            margin: 20px auto;

            display: block;

        }



        .button-container {

            position: fixed;

            bottom: 0;

            left: 0;

            right: 0;

            padding: 38px;

            background-color: #F7F7F7;

            border-top: 1px solid #E5E5E5;

        }



        .close-button {

            width: 100%;

            background: #E31E24;

            color: white;

            border: none;

            border-radius: 12px;

            padding: 16px;

            font-size: 17px;

            font-weight: 500;

            cursor: pointer;

            margin-top: auto;

            margin-bottom: env(safe-area-inset-bottom);

            position: fixed;

            bottom: 16px;

            left: 16px;

            right: 16px;

            max-width: calc(100% - 32px);

        }



        .close-button:active {

            background: #C71A1F;

        }



        .tab-icon {

            width: 24px;

            height: 24px;

            margin-right: 12px;

        }



        .tab-icon svg {

            width: 100%;

            height: 100%;

            fill: currentColor;

        }



        /* Стили для иконок */

        .icon-user svg,

        .icon-bus svg,

        .icon-rub svg,

        .icon-calendar svg,

        .icon-clock svg {

            width: 28px;

            height: 28px;

            fill: currentColor;

        }



        /* Стиль для маршрута */

        .route-info {

            display: flex;

            align-items: flex-start;

            gap: 12px;

            padding: 16px;

            border-bottom: 1px solid #E5E5E5;

        }



        .route-info svg {

            width: 24px;

            height: 24px;

            color: #8E8E93;

            flex-shrink: 0;

        }



        .route-info .info-content {

            display: flex;

            flex-direction: column;

            gap: 4px;

        }



        .route-info .info-label {

            font-size: 15px;

            color: #8E8E93;

        }



        .route-info .info-value {

            font-size: 17px;

            color: #000000;

        }



        /* Добавляем стиль для года внизу */

        .year-footer {

            text-align: center;

            font-size: 14px;

            color: #777777;

            margin-top: 20px;

            margin-bottom: 20px;

        }



        .ticket-info {

            display: flex;

            align-items: center;

            gap: 12px;

            margin-bottom: 16px;

        }



        .ticket-info svg {

            width: 24px;

            height: 24px;

            color: #000;

            flex-shrink: 0;

        }

    </style>

</head>

<body>

    <div class="container">

        <div class="timer" id="countdown">

            Действует: 15 сек.

        </div>



        <div class="tabs">

            <div class="tab active" data-tab="ticket">

                <div class="tab-icon">

                    <svg viewBox="0 0 576 512" xmlns="http://www.w3.org/2000/svg">

                        <path fill="currentColor" d="M320 48H63.1C55.16 48 47.1 55.16 47.1 64V448C47.1 456.8 55.16 464 63.1 464H284.5C296.5 482.4 311.9 498.5 329.7 511.3C326.6 511.7 323.3 512 320 512H64C28.65 512 0 483.3 0 448V64C0 28.65 28.65 0 64 0H320C355.3 0 384 28.65 384 64V198.6C366.8 203.5 350.6 210.9 336 220.5V63.1C336 55.16 328.8 47.1 320 47.1L320 48zM95.1 152C95.1 138.7 106.7 128 119.1 128H263.1C277.3 128 287.1 138.7 287.1 152C287.1 165.3 277.3 176 263.1 176H119.1C106.7 176 95.1 165.3 95.1 152zM263.1 224C277.3 224 287.1 234.7 287.1 248C287.1 261.3 277.3 272 263.1 272H119.1C106.7 272 95.1 261.3 95.1 248C95.1 234.7 106.7 224 119.1 224H263.1zM167.1 320C181.3 320 191.1 330.7 191.1 344C191.1 357.3 181.3 368 167.1 368H119.1C106.7 368 95.1 357.3 95.1 344C95.1 330.7 106.7 320 119.1 320H167.1zM576 368C576 447.5 511.5 512 432 512C352.5 512 287.1 447.5 287.1 368C287.1 288.5 352.5 224 432 224C511.5 224 576 288.5 576 368zM476.7 324.7L416 385.4L387.3 356.7C381.1 350.4 370.9 350.4 364.7 356.7C358.4 362.9 358.4 373.1 364.7 379.3L404.7 419.3C410.9 425.6 421.1 425.6 427.3 419.3L499.3 347.3C505.6 341.1 505.6 330.9 499.3 324.7C493.1 318.4 482.9 318.4 476.7 324.7H476.7z"></path>

                    </svg>

                </div>

                <span id="ticket-number-tab" style="color: #E31E24; font-weight: 500;">965 724 424</span>

            </div>

            <div class="tab" data-tab="control">

                <div class="tab-icon">

                    <svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">

                        <path fill="currentColor" d="M319.7 352.5L224 416l-95.7-63.49C57.05 355.2 0 413.4 0 485.3C0 500.1 11.94 512 26.66 512H421.3C436.1 512 448 500.1 448 485.3C448 413.4 390.1 355.2 319.7 352.5zM50.69 464c8.043-31.21 33.37-55.43 65.56-61.89L209.5 464H50.69zM238.5 464l93.28-61.89c32.19 6.461 57.52 30.68 65.56 61.89H238.5zM78.54 102.4v44.04C119.1 164.9 169.4 176 224 176s104.9-11.08 145.5-29.55V102.4l21.96-22.3c4.564-4.635 7.129-10.93 7.129-17.48c0-11.35-7.602-21.24-18.44-23.99l-148.3-37.67c-5.096-1.295-10.43-1.295-15.52 0l-148.3 37.67C57.06 41.39 49.46 51.28 49.46 62.62c0 6.555 2.564 12.85 7.129 17.48L78.54 102.4zM161.7 72.85c3.969-7.875 13.56-11.09 21.47-7.156L224 86.13l40.84-20.44c7.938-3.969 17.5-.7505 21.47 7.156c3.938 7.906 .75 17.5-7.156 21.47l-48 23.1C228.9 119.4 226.4 120 224 120S219.1 119.4 216.8 118.3l-48-23.1C160.9 90.35 157.8 80.75 161.7 72.85zM224 272c-41.23 0-74.9-31.51-79.15-71.64C128.1 197.1 112 192.8 96.45 187.5C96.4 189.1 96 190.5 96 192c0 70.69 57.31 128 127.1 128s127.1-57.31 127.1-128c0-1.525-.358-2.941-.4108-4.453C336 192.8 319.9 197.1 303.2 200.4C298.9 240.5 265.2 272 224 272z"></path>

                    </svg>

                </div>

                <span>Контроль</span>

            </div>

        </div>



        <div class="tab-content active" id="ticket-content">

            <div class="route-info">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 5C13.66 5 15 6.34 15 8C15 9.66 13.66 11 12 11C10.34 11 9 9.66 9 8C9 6.34 10.34 5 12 5ZM12 19.2C9.5 19.2 7.29 17.92 6 15.98C6.03 13.99 10 12.9 12 12.9C13.99 12.9 17.97 13.99 18 15.98C16.71 17.92 14.5 19.2 12 19.2Z" fill="currentColor"/>
                </svg>
                <div class="info-content">
                    <div class="info-label">Перевозчик</div>
                    <div class="info-value" id="carrier"></div>
                </div>
            </div>

            <div class="route-info">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M4 16C4 17.1 4.9 18 6 18H7V19C7 20.1 7.9 21 9 21H15C16.1 21 17 20.1 17 19V18H18C19.1 18 20 17.1 20 16V11H4V16ZM6.5 16C5.67 16 5 15.33 5 14.5C5 13.67 5.67 13 6.5 13C7.33 13 8 13.67 8 14.5C8 15.33 7.33 16 6.5 16ZM17.5 16C16.67 16 16 15.33 16 14.5C16 13.67 16.67 13 17.5 13C18.33 13 19 13.67 19 14.5C19 15.33 18.33 16 17.5 16ZM18 9H6V4H18V9Z" fill="currentColor"/>
                </svg>
                <div class="info-content">
                    <div class="info-label">Маршрут</div>
                    <div class="info-value" id="route"></div>
                    <div class="info-value" id="vehicle"></div>
                </div>
            </div>

            <div class="route-info">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M11.8 10.9C9.53 10.31 8.8 9.7 8.8 8.75C8.8 7.66 9.81 6.9 11.5 6.9C13.28 6.9 13.94 7.75 14 9H16.21C16.14 7.28 15.09 5.7 13 5.19V3H10V5.16C8.06 5.58 6.5 6.84 6.5 8.77C6.5 11.08 8.41 12.23 11.2 12.9C13.7 13.5 14.2 14.38 14.2 15.31C14.2 16 13.71 17.1 11.5 17.1C9.44 17.1 8.63 16.18 8.52 15H6.32C6.44 17.19 8.08 18.42 10 18.83V21H13V18.85C14.95 18.48 16.5 17.35 16.5 15.3C16.5 12.46 14.07 11.49 11.8 10.9Z" fill="currentColor"/>
                </svg>
                <div class="info-content">
                    <div class="info-label">Тариф</div>
                    <div class="info-value">Полный - <span id="cost"></span> ₽</div>
                </div>
            </div>

            <div class="info-row">
                <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill="currentColor" d="M38 6h-2v-4h-4v4h-16v-4h-4v4h-2c-2.21 0-3.98 1.79-3.98 4l-.02 28c0 2.21 1.79 4 4 4h28c2.21 0 4-1.79 4-4v-28c0-2.21-1.79-4-4-4zm0 32h-28v-22h28v22zm-24-18h10v10h-10z"/>
                </svg>
                <div class="info-content">
                    <div class="info-label">Дата покупки</div>
                    <div class="info-value" id="purchase-date"></div>
                </div>
            </div>

            <div class="info-row">
                <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/>
                </svg>
                <div class="info-content">
                    <div class="info-label">Время покупки</div>
                    <div class="info-value" id="purchase-time"></div>
                </div>
            </div>

        </div>



        <div class="tab-content" id="control-content">

            <div class="control-info">

                Для проверки билета покажите QR-код контролеру

            </div>

            <img id="qr-code" src="" alt="QR-код">

        </div>

    </div>



    <div class="button-container">

        <button class="close-button" id="close-button">ЗАКРЫТЬ</button>

    </div>



    <script>

        // Инициализация Telegram WebApp

        window.Telegram.WebApp.ready();

        window.Telegram.WebApp.expand();



        // Константы для GitHub

        const GITHUB_REPO = "competidora-cmd/telegram-mini-app";

        const GITHUB_BRANCH = "main";



        // Тихая проверка обновлений при запуске

        checkForUpdates();



        // Функция для проверки обновлений с GitHub

        async function checkForUpdates() {

            try {

                console.log('Проверка обновлений с GitHub...');

                

                // Получаем последний коммит в репозитории

                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/commits/${GITHUB_BRANCH}`);

                if (!response.ok) {

                    console.log('Не удалось получить информацию о последнем коммите');

                    return;

                }

                

                const commitData = await response.json();

                const lastCommitSha = commitData.sha;

                

                // Проверяем, есть ли сохраненный SHA последнего коммита

                const savedCommitSha = localStorage.getItem('lastCommitSha');

                

                if (savedCommitSha !== lastCommitSha) {

                    console.log('Обнаружены обновления, тихая синхронизация...');

                    localStorage.setItem('lastCommitSha', lastCommitSha);

                    window.location.reload(true);

                } else {

                    console.log('Обновлений нет, используется последняя версия');

                }

            } catch (error) {

                console.log('Ошибка при проверке обновлений:', error);

            }

        }



        // Получаем параметры из URL

        const urlParams = new URLSearchParams(window.location.search);

        const code = urlParams.get('code') || '965724424';

        const carrier = urlParams.get('carrier') || 'ИП Патрин Н. Н.';

        const route = urlParams.get('route') || '6, Студенческий городок - Утиный плёс';

        const vehicle = urlParams.get('vehicle') || 'р471тм124';

        const cost = urlParams.get('cost') || '44.00';

        

        // Получаем текущую дату и время

        const now = new Date();

        

        // Форматируем дату в формате "день месяц год г."

        function formatDate(date) {

            const day = date.getDate();

            const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 

                           'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];

            const month = months[date.getMonth()];

            const year = date.getFullYear();

            return `${day} ${month} ${year} г.`;

        }

        

        // Форматируем время в формате "ЧЧ:ММ"

        function formatTime(date) {

            const hours = date.getHours().toString().padStart(2, '0');

            const minutes = date.getMinutes().toString().padStart(2, '0');

            return `${hours}:${minutes}`;

        }

        

        const purchaseDate = urlParams.get('purchase_date') || formatDate(now);

        const purchaseTime = urlParams.get('purchase_time') || formatTime(now);



        // Заполняем информацию о билете

        document.getElementById('ticket-number-tab').textContent = formatTicketNumber(code);

        document.getElementById('carrier').textContent = carrier;

        

        // Устанавливаем маршрут в формате "номер, название маршрута"

        document.getElementById('route').textContent = route;

        document.getElementById('vehicle').textContent = vehicle;

        

        document.getElementById('cost').textContent = `1 шт., Полный, ${cost} ₽`;

        document.getElementById('purchase-date').textContent = purchaseDate;

        document.getElementById('purchase-time').textContent = purchaseTime;

        

        // Генерируем QR-код

        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(code)}`;

        document.getElementById('qr-code').src = qrCodeUrl;



        // Обработчик для переключения вкладок

        document.querySelectorAll('.tab').forEach(tab => {

            tab.addEventListener('click', () => {

                const tabId = tab.getAttribute('data-tab');

                

                // Удаляем активный класс у всех вкладок и контента

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                

                // Добавляем активный класс выбранной вкладке и контенту

                tab.classList.add('active');

                document.getElementById(`${tabId}-content`).classList.add('active');

            });

        });



        // Обработчик для кнопки закрытия

        document.getElementById('close-button').addEventListener('click', () => {

            if (window.Telegram && window.Telegram.WebApp) {

                window.Telegram.WebApp.close();

            }

        });



        // Функция для форматирования номера билета

        function formatTicketNumber(code) {

            if (!code) return '';

            return code.toString().replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');

        }



        // Обратный отсчет

        let seconds = 15;

        const countdownElement = document.getElementById('countdown');

        

        function updateCountdown() {

            countdownElement.textContent = `Действует: ${seconds} сек.`;

            if (seconds > 0) {

                seconds--;

                setTimeout(updateCountdown, 1000);

            } else {

                countdownElement.textContent = 'Время истекло';

                setTimeout(() => {

                    if (window.Telegram && window.Telegram.WebApp) {

                        window.Telegram.WebApp.close();

                    }

                }, 1000);

            }

        }

        

        // Запускаем обратный отсчет

        updateCountdown();

    </script>

</body>

</html>

