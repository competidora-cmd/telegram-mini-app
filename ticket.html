<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Городской Транспорт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: white;
            -webkit-text-size-adjust: none;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            padding: 0;
            background-color: white;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* Отступ для кнопки закрытия */
        }

        .timer {
            text-align: center;
            font-size: 24px;
            font-weight: 400;
            margin: 20px 0;
            color: #000000;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #E0E0E0;
            margin-bottom: 15px;
            padding: 0 16px;
        }

        .tab {
            padding: 12px 0;
            margin-right: 24px;
            text-align: center;
            cursor: pointer;
            color: #999;
            position: relative;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .tab.active {
            color: #000;
        }

        .tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #E31E24;
        }

        .tab-content {
            display: none;
            padding: 0 16px;
        }

        .tab-content.active {
            display: block;
        }

        .ticket-number {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #E0E0E0;
        }

        .ticket-number-icon {
            margin-right: 10px;
            color: #E31E24;
        }

        .ticket-number-value {
            color: #E31E24;
            font-size: 18px;
            font-weight: 500;
        }

        .info-row {
            display: flex;
            padding: 16px 0;
            border-bottom: 1px solid #E0E0E0;
        }

        .info-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-content {
            flex: 1;
        }

        .info-label {
            color: #999;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .info-value {
            color: #000;
            font-size: 16px;
            font-weight: 500;
        }

        .control-info {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-size: 16px;
        }

        #qr-code {
            width: 80%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
        }

        .button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background-color: white;
            border-top: 1px solid #F0F0F0;
        }

        .close-button {
            background-color: #E31E24;
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .tab-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        /* Стили для иконок */
        .icon-user svg,
        .icon-bus svg,
        .icon-rub svg,
        .icon-calendar svg,
        .icon-clock svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Стиль для маршрута */
        .route-info {
            display: flex;
            flex-direction: column;
        }

        .route-name {
            font-size: 16px;
            font-weight: 500;
            color: #000;
        }

        .route-number {
            font-size: 16px;
            font-weight: 500;
            color: #000;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="timer" id="countdown">
            Действует: 10 сек.
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="ticket">
                <div class="tab-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12M22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2A10,10 0 0,1 22,12M10,9.5C10,10.3 9.3,11 8.5,11C7.7,11 7,10.3 7,9.5C7,8.7 7.7,8 8.5,8C9.3,8 10,8.7 10,9.5M17,9.5C17,10.3 16.3,11 15.5,11C14.7,11 14,10.3 14,9.5C14,8.7 14.7,8 15.5,8C16.3,8 17,8.7 17,9.5M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z"></path>
                    </svg>
                </div>
                <span>965 724 424</span>
            </div>
            <div class="tab" data-tab="control">
                <div class="tab-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"></path>
                    </svg>
                </div>
                <span>Контроль</span>
            </div>
        </div>

        <div class="tab-content active" id="ticket-content">
            <div class="ticket-number">
                <div class="ticket-number-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#E31E24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12M22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2A10,10 0 0,1 22,12M10,9.5C10,10.3 9.3,11 8.5,11C7.7,11 7,10.3 7,9.5C7,8.7 7.7,8 8.5,8C9.3,8 10,8.7 10,9.5M17,9.5C17,10.3 16.3,11 15.5,11C14.7,11 14,10.3 14,9.5C14,8.7 14.7,8 15.5,8C16.3,8 17,8.7 17,9.5M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z"></path>
                    </svg>
                </div>
                <span id="ticket-number" class="ticket-number-value">965 724 424</span>
            </div>

            <div class="info-row">
                <div class="info-icon icon-user">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"></path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">Перевозчик</div>
                    <div class="info-value" id="carrier">ИП Патрин Н. Н.</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-icon icon-bus">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18,11H6V6H18M16.5,17A1.5,1.5 0 0,1 15,15.5A1.5,1.5 0 0,1 16.5,14A1.5,1.5 0 0,1 18,15.5A1.5,1.5 0 0,1 16.5,17M7.5,17A1.5,1.5 0 0,1 6,15.5A1.5,1.5 0 0,1 7.5,14A1.5,1.5 0 0,1 9,15.5A1.5,1.5 0 0,1 7.5,17M4,16C4,16.88 4.39,17.67 5,18.22V20A1,1 0 0,0 6,21H7A1,1 0 0,0 8,20V19H16V20A1,1 0 0,0 17,21H18A1,1 0 0,0 19,20V18.22C19.61,17.67 20,16.88 20,16V6C20,2.5 16.42,2 12,2C7.58,2 4,2.5 4,6V16Z"></path>
                    </svg>
                </div>
                <div class="info-content route-info">
                    <div class="route-name" id="route-name">Красфарма (60 лет Октября) - Х/К Енисей</div>
                    <div class="route-number" id="route-number">р471тм124</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-icon icon-rub">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5,3H7V12H5V14H7V16H5V18H7V21H9V18H13V16H9V14H13.5A5.5,5.5 0 0,0 19,8.5A5.5,5.5 0 0,0 13.5,3M13.5,12H9V5H13.5A3.5,3.5 0 0,1 17,8.5A3.5,3.5 0 0,1 13.5,12Z"></path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">Стоимость</div>
                    <div class="info-value" id="cost">1 шт., Полный, 44.00 ₽</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-icon icon-calendar">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"></path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">Дата покупки</div>
                    <div class="info-value" id="purchase-date">15 марта 2025 г.</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-icon icon-clock">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"></path>
                    </svg>
                </div>
                <div class="info-content">
                    <div class="info-label">Время покупки</div>
                    <div class="info-value" id="purchase-time">09:03</div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="control-content">
            <div class="control-info">
                Для проверки билета покажите QR-код контролеру
            </div>
            <img id="qr-code" src="" alt="QR-код">
        </div>
    </div>

    <div class="button-container">
        <button class="close-button" id="close-button">ЗАКРЫТЬ</button>
    </div>

    <script>
        // Инициализация Telegram WebApp
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        // Константы для GitHub
        const GITHUB_REPO = "competidora-cmd/telegram-mini-app";
        const GITHUB_BRANCH = "main";

        // Проверяем обновления при запуске
        checkForUpdates();

        // Функция для проверки обновлений с GitHub
        async function checkForUpdates() {
            try {
                console.log('Проверка обновлений с GitHub...');
                
                // Получаем последний коммит в репозитории
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/commits/${GITHUB_BRANCH}`);
                if (!response.ok) {
                    throw new Error('Не удалось получить информацию о последнем коммите');
                }
                
                const commitData = await response.json();
                const lastCommitSha = commitData.sha;
                
                // Проверяем, есть ли сохраненный SHA последнего коммита
                const savedCommitSha = localStorage.getItem('lastCommitSha');
                
                if (savedCommitSha !== lastCommitSha) {
                    console.log('Обнаружены обновления, синхронизация...');
                    
                    // Сохраняем новый SHA
                    localStorage.setItem('lastCommitSha', lastCommitSha);
                    
                    // Если есть обновления, перезагружаем страницу для получения последней версии
                    if (confirm('Доступна новая версия приложения. Обновить сейчас?')) {
                        window.location.reload(true);
                    }
                } else {
                    console.log('Обновлений нет, используется последняя версия');
                }
            } catch (error) {
                console.error('Ошибка при проверке обновлений:', error);
            }
        }

        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code') || '965724424';
        const carrier = urlParams.get('carrier') || 'ИП Патрин Н. Н.';
        const route = urlParams.get('route') || 'Красфарма (60 лет Октября) - Х/К Енисей';
        const vehicle = urlParams.get('vehicle') || 'р471тм124';
        const cost = urlParams.get('cost') || '44.00';
        const purchaseDate = urlParams.get('purchase_date') || '15 марта 2025 г.';
        const purchaseTime = urlParams.get('purchase_time') || '09:03';

        // Заполняем информацию о билете
        document.getElementById('ticket-number').textContent = formatTicketNumber(code);
        document.getElementById('carrier').textContent = carrier;
        
        // Разделяем маршрут на название и номер (если есть)
        const routeParts = route.split(', ');
        if (routeParts.length > 1) {
            document.getElementById('route-name').textContent = routeParts[0];
            document.getElementById('route-number').textContent = routeParts[1];
        } else {
            document.getElementById('route-name').textContent = route;
            document.getElementById('route-number').textContent = vehicle;
        }
        
        document.getElementById('cost').textContent = `1 шт., Полный, ${cost} ₽`;
        document.getElementById('purchase-date').textContent = purchaseDate;
        document.getElementById('purchase-time').textContent = purchaseTime;

        // Генерируем QR-код
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(code)}`;
        document.getElementById('qr-code').src = qrCodeUrl;

        // Обработчик для переключения вкладок
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Удаляем активный класс у всех вкладок и контента
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Добавляем активный класс выбранной вкладке и контенту
                tab.classList.add('active');
                document.getElementById(`${tabId}-content`).classList.add('active');
            });
        });

        // Обработчик для кнопки закрытия
        document.getElementById('close-button').addEventListener('click', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            }
        });

        // Функция для форматирования номера билета
        function formatTicketNumber(code) {
            if (!code) return '';
            return code.toString().replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }

        // Таймер обратного отсчета
        let seconds = 10;
        const countdownElement = document.getElementById('countdown');
        
        function updateCountdown() {
            countdownElement.textContent = `Действует: ${seconds} сек.`;
            if (seconds > 0) {
                seconds--;
                setTimeout(updateCountdown, 1000);
            }
        }
        
        updateCountdown();
    </script>
</body>
</html>
